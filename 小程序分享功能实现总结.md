# å°ç¨‹åºåˆ†äº«åŠŸèƒ½å®ç°æ€»ç»“

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. æ•°æ®åº“å±‚é¢
- âœ… åœ¨ `mini_app_users` è¡¨ä¸­æ·»åŠ äº† `referrer_id` å­—æ®µï¼ˆåˆ†äº«è€…ç”¨æˆ·IDï¼‰
- âœ… æ•°æ®åº“è¿ç§»è„šæœ¬å·²æ›´æ–°ï¼Œè‡ªåŠ¨æ·»åŠ è¯¥å­—æ®µ

### 2. åç«¯å®ç°

#### 2.1 æ•°æ®æ¨¡å‹æ›´æ–°
- âœ… `MiniAppUser` ç»“æ„ä½“æ·»åŠ äº† `ReferrerID` å­—æ®µ
- âœ… æ‰€æœ‰æŸ¥è¯¢ç”¨æˆ·çš„æ–¹æ³•å·²æ›´æ–°ï¼ŒåŒ…å« `referrer_id` å­—æ®µï¼š
  - `GetMiniAppUserByUniqueID`
  - `GetMiniAppUserByUserCode`
  - `GetMiniAppUserByID`
  - `GetMiniAppUsers`
  - `GetMiniAppUsersByIDs`
- âœ… æ–°å¢ `GetMiniAppUsersByReferrerID` æ–¹æ³•ï¼Œç”¨äºè·å–æŸä¸ªç”¨æˆ·æ‹‰å–çš„æ–°ç”¨æˆ·åˆ—è¡¨

#### 2.2 ç”¨æˆ·åˆ›å»ºé€»è¾‘
- âœ… `CreateMiniAppUser` æ–¹æ³•æ”¯æŒä¼ å…¥ `referrer_id` å‚æ•°
- âœ… è‡ªåŠ¨ç»‘å®šåˆ†äº«è€…é€»è¾‘ï¼š
  - æ£€æŸ¥åˆ†äº«è€…æ˜¯å¦å­˜åœ¨ä¸”ä¸æ˜¯è‡ªå·±
  - å¦‚æœåˆ†äº«è€…æ˜¯é”€å”®å‘˜ï¼ˆ`is_sales_employee = true`ï¼‰ï¼Œè‡ªåŠ¨ç»‘å®šè¯¥é”€å”®å‘˜
  - å¦‚æœåˆ†äº«è€…ç»‘å®šäº†é”€å”®å‘˜ï¼Œæ–°ç”¨æˆ·ä¹Ÿç»‘å®šç›¸åŒçš„é”€å”®å‘˜
  - åŒæ—¶è®¾ç½® `referrer_id`ã€`sales_employee_id` å’Œ `sales_code`

#### 2.3 ç™»å½•æ¥å£
- âœ… `MiniAppLogin` æ¥å£æ”¯æŒæ¥æ”¶ `referrer_id` å‚æ•°
- âœ… æ–°ç”¨æˆ·é¦–æ¬¡ç™»å½•æ—¶è‡ªåŠ¨ç»‘å®šåˆ†äº«è€…
- âœ… å·²å­˜åœ¨çš„ç”¨æˆ·ä¸ä¼šé‡æ–°ç»‘å®šï¼ˆé˜²æ­¢è¦†ç›–ï¼‰

#### 2.4 ç»Ÿè®¡æ¥å£
- âœ… æ–°å¢ `GetUserReferralStats` æ¥å£ï¼Œç”¨äºè·å–ç”¨æˆ·æ‹‰æ–°ç»Ÿè®¡
- âœ… è·¯ç”±ï¼š`GET /admin/mini-app/users/referral-stats?user_id=123`
- âœ… è¿”å›è¯¥ç”¨æˆ·æ‹‰å–çš„æ–°ç”¨æˆ·æ•°é‡å’Œåˆ—è¡¨

### 3. å‰ç«¯å®ç°

#### 3.1 App.vue
- âœ… `onLaunch` æ–¹æ³•ä¸­æ£€æµ‹åˆ†äº«å‚æ•° `referrer_id`
- âœ… `onShow` æ–¹æ³•ä¸­æ£€æµ‹åˆ†äº«å‚æ•°ï¼ˆä»å…¶ä»–å°ç¨‹åºæ‰“å¼€ï¼‰
- âœ… ä¿å­˜åˆ†äº«è€…IDåˆ°æœ¬åœ°å­˜å‚¨ `shareReferrerId`

#### 3.2 ç™»å½•é€»è¾‘
- âœ… `LoginModal.vue`ï¼šç™»å½•æ—¶è¯»å–æœ¬åœ°å­˜å‚¨çš„ `shareReferrerId` å¹¶ä¼ é€’ç»™åç«¯
- âœ… `ProductSelector.vue`ï¼šç™»å½•æ—¶è¯»å–æœ¬åœ°å­˜å‚¨çš„ `shareReferrerId` å¹¶ä¼ é€’ç»™åç«¯
- âœ… `api/index.js`ï¼š`miniLogin` æ–¹æ³•æ”¯æŒ `referrer_id` å‚æ•°
- âœ… ç™»å½•æˆåŠŸåæ¸…é™¤åˆ†äº«è€…IDï¼ˆåªç»‘å®šä¸€æ¬¡ï¼‰

#### 3.3 åˆ†äº«åŠŸèƒ½
- âœ… **é¦–é¡µ** (`pages/index/index.vue`)ï¼š
  - æ·»åŠ  `onShareAppMessage` æ–¹æ³•
  - åˆ†äº«è·¯å¾„ï¼š`/pages/index/index?referrer_id={userId}`
  - åˆ†äº«æ ‡é¢˜ï¼š`å‘ç°å¥½å•†å“ï¼Œå¿«æ¥é€‰è´­å§ï¼`

- âœ… **å•†å“è¯¦æƒ…é¡µ** (`pages/product/detail.vue`)ï¼š
  - å®Œå–„ `onShareAppMessage` æ–¹æ³•
  - åˆ†äº«è·¯å¾„ï¼š`/pages/product/detail?id={productId}&referrer_id={userId}`
  - åˆ†äº«æ ‡é¢˜ï¼š`{å•†å“åç§°} - å¿«æ¥é€‰è´­å§ï¼`
  - åˆ†äº«å›¾ç‰‡ï¼šå•†å“ç¬¬ä¸€å¼ å›¾ç‰‡

- âœ… **è®¢å•è¯¦æƒ…é¡µ** (`pages/order/detail.vue`)ï¼š
  - æ·»åŠ  `onShareAppMessage` æ–¹æ³•
  - åˆ†äº«è·¯å¾„ï¼š`/pages/order/detail?id={orderId}&referrer_id={userId}`
  - åˆ†äº«æ ‡é¢˜ï¼š`è®¢å•è¯¦æƒ… - è®¢å•å·ï¼š{è®¢å•å·}`

## ğŸ”„ ä¸šåŠ¡æµç¨‹

### å®Œæ•´æµç¨‹ç¤ºä¾‹

1. **ç”¨æˆ·Aï¼ˆID=123ï¼‰åˆ†äº«å°ç¨‹åº**
   - ç”¨æˆ·Aåœ¨é¦–é¡µç‚¹å‡»åˆ†äº«æŒ‰é’®
   - ç³»ç»Ÿç”Ÿæˆåˆ†äº«é“¾æ¥ï¼š`/pages/index/index?referrer_id=123`
   - ç”¨æˆ·Aåˆ†äº«ç»™ç”¨æˆ·B

2. **ç”¨æˆ·Bé€šè¿‡åˆ†äº«é“¾æ¥æ‰“å¼€å°ç¨‹åº**
   - App.vue çš„ `onLaunch` æ£€æµ‹åˆ° `referrer_id=123`
   - ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼š`uni.setStorageSync('shareReferrerId', '123')`

3. **ç”¨æˆ·Bé¦–æ¬¡ç™»å½•**
   - ç”¨æˆ·Bç‚¹å‡»ç™»å½•
   - `LoginModal.vue` è¯»å–æœ¬åœ°å­˜å‚¨çš„ `shareReferrerId = 123`
   - è°ƒç”¨ç™»å½•æ¥å£ï¼š`POST /api/mini/auth/login`ï¼Œä¼ é€’ `{ code: 'xxx', referrer_id: 123 }`
   - åç«¯åˆ›å»ºæ–°ç”¨æˆ·ï¼Œè®¾ç½® `referrer_id = 123`
   - å¦‚æœç”¨æˆ·Aæ˜¯é”€å”®å‘˜ï¼Œè‡ªåŠ¨ç»‘å®šç”¨æˆ·Açš„é”€å”®å‘˜ä¿¡æ¯
   - ç™»å½•æˆåŠŸåï¼Œæ¸…é™¤æœ¬åœ°å­˜å‚¨çš„ `shareReferrerId`

4. **æ•°æ®ç»Ÿè®¡**
   - åå°å¯ä»¥æŸ¥çœ‹ç”¨æˆ·Aæ‹‰å–çš„æ–°ç”¨æˆ·æ•°é‡
   - è°ƒç”¨æ¥å£ï¼š`GET /admin/mini-app/users/referral-stats?user_id=123`
   - è¿”å›ç”¨æˆ·Aæ‹‰å–çš„æ‰€æœ‰æ–°ç”¨æˆ·åˆ—è¡¨

## ğŸ“Š æ•°æ®ç»Ÿè®¡

### SQL æŸ¥è¯¢ç¤ºä¾‹

```sql
-- ç»Ÿè®¡æ¯ä¸ªç”¨æˆ·æ‹‰å–çš„æ–°ç”¨æˆ·æ•°é‡
SELECT 
    referrer_id,
    COUNT(*) as new_users_count
FROM mini_app_users 
WHERE referrer_id IS NOT NULL 
GROUP BY referrer_id
ORDER BY new_users_count DESC;

-- æŸ¥çœ‹æŸä¸ªç”¨æˆ·æ‹‰å–çš„æ‰€æœ‰æ–°ç”¨æˆ·
SELECT * 
FROM mini_app_users 
WHERE referrer_id = 123
ORDER BY created_at DESC;

-- ç»Ÿè®¡é”€å”®å‘˜é€šè¿‡åˆ†äº«æ‹‰å–çš„æ–°ç”¨æˆ·æ•°é‡
SELECT 
    u.referrer_id,
    u.sales_code,
    COUNT(*) as new_users_count
FROM mini_app_users u
WHERE u.referrer_id IS NOT NULL 
  AND u.sales_code IS NOT NULL
GROUP BY u.referrer_id, u.sales_code
ORDER BY new_users_count DESC;
```

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

1. **è‡ªåŠ¨ç»‘å®šåˆ†äº«è€…**ï¼šæ–°ç”¨æˆ·é€šè¿‡åˆ†äº«é“¾æ¥æ‰“å¼€å°ç¨‹åºåï¼Œé¦–æ¬¡ç™»å½•æ—¶è‡ªåŠ¨ç»‘å®šåˆ†äº«è€…
2. **é”€å”®å‘˜è‡ªåŠ¨ç»‘å®š**ï¼šå¦‚æœåˆ†äº«è€…æ˜¯é”€å”®å‘˜ï¼Œæ–°ç”¨æˆ·è‡ªåŠ¨ç»‘å®šè¯¥é”€å”®å‘˜ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
3. **é˜²æ­¢é‡å¤ç»‘å®š**ï¼šå·²ç»‘å®šé”€å”®å‘˜çš„ç”¨æˆ·ï¼Œä¸ä¼šå› ä¸ºåˆ†äº«è€Œé‡æ–°ç»‘å®š
4. **é˜²æ­¢è‡ªå·±ç»‘å®šè‡ªå·±**ï¼šåˆ†äº«è€…ä¸èƒ½ç»‘å®šè‡ªå·±
5. **åªç»‘å®šä¸€æ¬¡**ï¼šæ–°ç”¨æˆ·é¦–æ¬¡ç™»å½•æ—¶æ‰ç»‘å®šï¼Œåç»­ç™»å½•ä¸å†ç»‘å®š

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **åˆ†äº«è€…IDè·å–**ï¼šåˆ†äº«æ—¶ä½¿ç”¨å½“å‰ç™»å½•ç”¨æˆ·çš„ `id` å­—æ®µï¼ˆä¸æ˜¯ `unique_id`ï¼‰
2. **æœ¬åœ°å­˜å‚¨**ï¼šåˆ†äº«è€…IDä¿å­˜åœ¨ `shareReferrerId` é”®ä¸­
3. **æ¸…é™¤æ—¶æœº**ï¼šç™»å½•æˆåŠŸåç«‹å³æ¸…é™¤åˆ†äº«è€…IDï¼Œç¡®ä¿åªç»‘å®šä¸€æ¬¡
4. **å‚æ•°ä¼ é€’**ï¼šåˆ†äº«è·¯å¾„ä¸­çš„ `referrer_id` å‚æ•°ä¼šè¢« App.vue è‡ªåŠ¨æ£€æµ‹å¹¶ä¿å­˜

## ğŸš€ æµ‹è¯•å»ºè®®

1. **æµ‹è¯•åˆ†äº«åŠŸèƒ½**ï¼š
   - ç”¨æˆ·Aç™»å½•å°ç¨‹åº
   - åœ¨é¦–é¡µã€å•†å“è¯¦æƒ…é¡µã€è®¢å•è¯¦æƒ…é¡µç‚¹å‡»åˆ†äº«
   - æ£€æŸ¥åˆ†äº«è·¯å¾„æ˜¯å¦åŒ…å« `referrer_id` å‚æ•°

2. **æµ‹è¯•ç»‘å®šåŠŸèƒ½**ï¼š
   - ç”¨æˆ·Bé€šè¿‡åˆ†äº«é“¾æ¥æ‰“å¼€å°ç¨‹åºï¼ˆæ–°ç”¨æˆ·ï¼‰
   - é¦–æ¬¡ç™»å½•
   - æ£€æŸ¥æ•°æ®åº“ä¸­ `referrer_id` æ˜¯å¦æ­£ç¡®è®¾ç½®
   - å¦‚æœç”¨æˆ·Aæ˜¯é”€å”®å‘˜ï¼Œæ£€æŸ¥ `sales_code` å’Œ `sales_employee_id` æ˜¯å¦æ­£ç¡®ç»‘å®š

3. **æµ‹è¯•ç»Ÿè®¡åŠŸèƒ½**ï¼š
   - åœ¨åå°è°ƒç”¨ç»Ÿè®¡æ¥å£
   - æ£€æŸ¥è¿”å›çš„æ•°æ®æ˜¯å¦æ­£ç¡®

## ğŸ“Œ ç›¸å…³æ–‡ä»¶

### åç«¯æ–‡ä»¶
- `go_backend/internal/database/database.go` - æ•°æ®åº“å­—æ®µæ·»åŠ 
- `go_backend/internal/model/mini_user.go` - ç”¨æˆ·æ¨¡å‹å’ŒæŸ¥è¯¢æ–¹æ³•
- `go_backend/internal/api/mini_app_auth.go` - ç™»å½•æ¥å£å’Œç»Ÿè®¡æ¥å£

### å‰ç«¯æ–‡ä»¶
- `mini_app/App.vue` - åˆ†äº«å‚æ•°æ£€æµ‹
- `mini_app/pages/index/index.vue` - é¦–é¡µåˆ†äº«
- `mini_app/pages/product/detail.vue` - å•†å“è¯¦æƒ…é¡µåˆ†äº«
- `mini_app/pages/order/detail.vue` - è®¢å•è¯¦æƒ…é¡µåˆ†äº«
- `mini_app/components/LoginModal.vue` - ç™»å½•é€»è¾‘
- `mini_app/components/ProductSelector.vue` - ç™»å½•é€»è¾‘
- `mini_app/api/index.js` - API æ¥å£

