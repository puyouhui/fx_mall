# 小程序分享功能实现方案

## 📋 功能需求

1. **分享功能**：在首页、商品详情页、订单详情页等页面添加分享功能
2. **分享者绑定**：新用户通过分享链接打开小程序后，自动绑定分享者
3. **销售员自动绑定**：如果分享者是销售员，新用户自动绑定该销售员
4. **数据统计**：后台可以查看每个用户拉取了多少新用户

## 🗄️ 数据库设计

### 已添加字段
- `mini_app_users.referrer_id`：分享者用户ID（谁分享给我的）

## 🔧 实现步骤

### 1. 后端实现 ✅

#### 1.1 数据库字段添加 ✅
- ✅ 在 `mini_app_users` 表中添加 `referrer_id` 字段
- ✅ 更新所有查询用户的方法，包含 `referrer_id` 字段

#### 1.2 修改 CreateMiniAppUser 方法 ✅
- ✅ 支持传入 `referrer_id` 参数
- ✅ 如果分享者是销售员，自动绑定销售员
- ✅ 如果分享者绑定了销售员，新用户也绑定相同的销售员
- ✅ 防止自己绑定自己

#### 1.3 修改登录接口 ✅
- ✅ 接收 `referrer_id` 参数（从请求中读取）
- ✅ 首次登录时绑定分享者
- ✅ 如果分享者是销售员，自动绑定销售员

### 2. 前端实现 ✅

#### 2.1 App.vue 修改 ✅
- ✅ 在 `onLaunch` 中检查分享参数
- ✅ 在 `onShow` 中检查分享参数（从其他小程序打开）
- ✅ 保存分享者ID到本地存储 `shareReferrerId`

#### 2.2 各页面添加分享功能 ✅
- ✅ **首页**：添加 `onShareAppMessage` 方法，分享路径包含 `referrer_id`
- ✅ **商品详情页**：完善 `onShareAppMessage` 方法，分享商品详情页
- ✅ **订单详情页**：添加 `onShareAppMessage` 方法，分享订单详情页

#### 2.3 登录逻辑修改 ✅
- ✅ `LoginModal.vue`：登录时检查本地存储的分享者ID并传递给后端
- ✅ `ProductSelector.vue`：登录时检查本地存储的分享者ID并传递给后端
- ✅ 登录成功后清除分享者ID（只绑定一次）

## 📝 分享参数格式

小程序分享时，在 `path` 中添加分享者ID参数：
```
pages/index/index?referrer_id=123
pages/product/detail?id=456&referrer_id=123
pages/order/detail?id=789&referrer_id=123
```

## 🔄 业务流程

1. **用户A分享小程序**
   - 点击分享按钮
   - 系统生成带 `referrer_id=A的用户ID` 的分享链接

2. **用户B通过分享链接打开小程序**
   - App.vue 检测到 `referrer_id` 参数
   - 保存到本地存储 `shareReferrerId`

3. **用户B首次登录**
   - 登录接口检查本地存储的 `shareReferrerId`
   - 如果存在且用户B是新用户，绑定分享者
   - 如果分享者是销售员，自动绑定销售员

4. **数据统计**
   - 后台可以查看每个用户的 `referrer_id`
   - 统计每个用户拉取的新用户数量

## ⚠️ 注意事项

1. **防止重复绑定**：已绑定销售员的用户，不再绑定分享者 ✅
2. **防止自己绑定自己**：分享者不能绑定自己 ✅
3. **只绑定一次**：新用户首次登录时才绑定，后续登录不再绑定 ✅

## 📊 已实现的功能

### 后端
- ✅ 数据库字段 `referrer_id` 已添加
- ✅ `MiniAppUser` 模型已更新，包含 `ReferrerID` 字段
- ✅ 所有查询用户的方法已更新，包含 `referrer_id` 字段
- ✅ `CreateMiniAppUser` 方法支持分享者绑定和销售员自动绑定
- ✅ 登录接口支持接收 `referrer_id` 参数

### 前端
- ✅ `App.vue` 已添加分享参数检测和保存逻辑
- ✅ `LoginModal.vue` 已添加分享者ID传递逻辑
- ✅ `ProductSelector.vue` 已添加分享者ID传递逻辑
- ✅ `api/index.js` 的 `miniLogin` 方法已支持 `referrer_id` 参数
- ✅ 首页已添加 `onShareAppMessage` 方法
- ✅ 商品详情页已完善 `onShareAppMessage` 方法
- ✅ 订单详情页已添加 `onShareAppMessage` 方法

## 🎯 使用说明

### 分享功能使用
1. 用户在首页、商品详情页或订单详情页点击分享按钮
2. 系统自动生成包含分享者ID的分享链接
3. 新用户通过分享链接打开小程序
4. 系统自动检测并保存分享者ID
5. 新用户首次登录时自动绑定分享者
6. 如果分享者是销售员，新用户自动绑定该销售员

### 数据查看
- 在后台管理系统中，可以查看每个用户的 `referrer_id` 字段
- 可以通过 SQL 查询统计每个用户拉取的新用户数量：
  ```sql
  SELECT referrer_id, COUNT(*) as new_users_count 
  FROM mini_app_users 
  WHERE referrer_id IS NOT NULL 
  GROUP BY referrer_id;
  ```

