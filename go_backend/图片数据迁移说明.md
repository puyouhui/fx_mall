# MinIO 图片数据迁移说明

## 概述

本次更新实现了图片索引数据库方案，将图片元数据存储在数据库中，实现真正的分页查询，性能从 O(n) 提升到 O(log n)。

## 修改内容

1. ✅ 创建了 `image_index` 数据库表
2. ✅ 创建了 `image_index.go` 模型文件
3. ✅ 修改了上传接口，上传时自动写入数据库索引
4. ✅ 修改了列表接口，从数据库查询（真正的分页）
5. ✅ 修改了删除接口，同步删除数据库记录
6. ✅ 创建了数据迁移脚本

## 迁移步骤

> **重要提示**：开发环境和生产环境需要**分别迁移**。开发环境迁移完成后，生产环境也需要执行相同的迁移步骤。

## 一、开发环境迁移

### 1. 启动后端服务（自动创建表）

启动后端服务后，`image_index` 表会自动创建：

```bash
cd go_backend
go run cmd/main.go
```

查看日志，确认看到：
```
图片索引表初始化成功
```

### 2. 编译迁移工具

```bash
cd go_backend
go build -o migrate_images.exe cmd/migrate_images/main.go
```

**注意**：Windows 上必须指定 `.exe` 扩展名，否则可能无法运行。

### 3. 运行迁移脚本

**Windows (PowerShell):**
```powershell
.\migrate_images.exe
```

**Windows (CMD):**
```cmd
migrate_images.exe
```

**Linux:**
```bash
./migrate_images
```

**注意**：
- 在 Windows PowerShell 中，需要使用 `.\` 前缀来运行当前目录下的可执行文件
- 在 Windows CMD 中，可以直接运行 `migrate_images.exe`
- 如果提示"不是内部或外部命令"，请确保：
  1. 当前目录在 `go_backend` 文件夹中
  2. 文件确实存在（可以用 `dir migrate_images.exe` 检查）
  3. 使用正确的命令格式（PowerShell 用 `.\migrate_images.exe`，CMD 用 `migrate_images.exe`）

### 4. 查看迁移结果

迁移脚本会输出：
```
=========================================
MinIO 图片数据迁移工具
=========================================
配置初始化完成
数据库连接成功
MinIO连接成功，存储桶验证通过
开始扫描MinIO桶中的图片...
已迁移 100 张图片（跳过 0 条重复记录，错误 0 条）...
已迁移 200 张图片（跳过 0 条重复记录，错误 0 条）...
...
=========================================
迁移完成！
成功迁移: 1234 张图片
跳过重复: 0 条记录
错误记录: 0 条
=========================================
```

### 5. 验证迁移结果

#### 方式1：查看数据库

```sql
-- 查看图片总数
SELECT COUNT(*) FROM image_index;

-- 按分类统计
SELECT category, COUNT(*) as count 
FROM image_index 
GROUP BY category 
ORDER BY count DESC;

-- 查看最新上传的图片
SELECT object_name, category, file_size, uploaded_at 
FROM image_index 
ORDER BY uploaded_at DESC 
LIMIT 10;
```

#### 方式2：测试图库管理接口

访问管理后台的图库管理页面，检查：
- 图片列表是否正常显示
- 分页是否正常工作
- 查询速度是否明显提升（应该从9秒降到<100ms）

## 二、生产环境迁移

### ⚠️ 重要：生产环境迁移前准备

1. **备份数据库**（强烈建议）
   ```bash
   # MySQL 备份示例
   mysqldump -u用户名 -p密码 数据库名 > backup_$(date +%Y%m%d_%H%M%S).sql
   ```

2. **确认配置正确**
   - 检查生产环境的 `config.json` 中的数据库和 MinIO 配置
   - 确保配置指向生产环境，而不是开发环境

3. **选择迁移时机**
   - 建议在业务低峰期执行（如凌晨）
   - 迁移过程不会影响现有功能，但建议先测试

### 生产环境迁移步骤

#### 步骤1：部署新代码

1. 将包含图片索引功能的新代码部署到生产环境
2. 重启后端服务，确保 `image_index` 表已创建
3. 检查日志确认：`图片索引表初始化成功`

#### 步骤2：编译迁移工具（在服务器上）

**Linux 服务器：**
```bash
cd /path/to/go_backend
go build -o migrate_images cmd/migrate_images/main.go
```

**如果服务器没有 Go 环境，可以在本地编译后上传：**
```bash
# 在本地（Windows）编译 Linux 版本
set GOOS=linux
set GOARCH=amd64
go build -o migrate_images_linux cmd/migrate_images/main.go

# 然后上传 migrate_images_linux 到服务器
```

#### 步骤3：运行迁移脚本

```bash
# 在服务器上运行
cd /path/to/go_backend
./migrate_images
```

**注意事项：**
- 迁移过程可能需要几分钟到几十分钟，取决于图片数量
- 迁移过程中可以继续使用系统，不会影响现有功能
- 建议在迁移过程中监控服务器资源使用情况

#### 步骤4：验证迁移结果

```sql
-- 连接生产数据库，检查迁移结果
SELECT COUNT(*) FROM image_index;

-- 按分类统计
SELECT category, COUNT(*) as count 
FROM image_index 
GROUP BY category 
ORDER BY count DESC;
```

#### 步骤5：测试功能

1. 访问生产环境的管理后台
2. 进入图库管理页面
3. 测试分页、分类筛选等功能
4. 确认查询速度是否提升

### 生产环境迁移注意事项

1. **数据安全**
   - 迁移前务必备份数据库
   - 迁移脚本是**只读**的（只读取 MinIO，写入数据库），不会删除或修改 MinIO 中的图片
   - 可以安全地重复运行迁移脚本（会自动跳过已存在的记录）

2. **性能影响**
   - 迁移过程会扫描 MinIO 中的所有图片，可能占用一定网络和 CPU 资源
   - 建议在业务低峰期执行
   - 如果图片数量很大（>10万张），可以考虑分批迁移

3. **回滚方案**
   - 如果迁移后出现问题，可以：
     1. 代码回滚到旧版本（使用 MinIO 直接查询）
     2. 数据库表可以保留，不影响其他功能
     3. MinIO 中的图片文件不会受影响

4. **监控建议**
   - 迁移过程中监控：
     - 数据库连接数
     - 服务器 CPU 和内存使用率
     - MinIO 访问情况
   - 迁移完成后检查：
     - 数据库 `image_index` 表记录数
     - 图库管理页面是否正常

## 注意事项

### 1. 数据一致性

- **上传新图片**：会自动写入数据库索引
- **删除图片**：会同步删除数据库记录和MinIO文件
- **如果数据库记录丢失**：可以重新运行迁移脚本（会自动跳过已存在的记录）

### 2. 重复运行迁移

迁移脚本支持重复运行：
- 已存在的记录会自动跳过（基于 `object_name` 的唯一约束）
- 只会迁移新增的图片

### 3. 性能提升

迁移后的性能对比：

| 操作 | 迁移前 | 迁移后 |
|------|--------|--------|
| 查询第1页（30张） | ~9秒 | <100ms |
| 查询第10页 | ~9秒 | <100ms |
| 按分类查询 | ~9秒 | <50ms |

### 4. 回滚方案（如果需要）

如果遇到问题需要回滚，可以：

1. **临时回滚代码**：修改 `handlers.go` 的 `ListImages` 函数，改回使用 `utils.ListImagesWithPagination`
2. **保留数据库表**：数据库表可以保留，不影响其他功能
3. **数据不会丢失**：MinIO 中的图片文件不会受影响

## 故障排查

### 问题1：迁移脚本报错 "存储桶不存在"

**解决**：检查 `config.json` 中的 MinIO 配置，确保：
- `endpoint` 正确
- `bucket` 名称正确
- `access_key` 和 `secret_key` 正确

### 问题2：迁移后图库管理页面显示为空

**解决**：
1. 检查数据库是否有数据：`SELECT COUNT(*) FROM image_index;`
2. 检查后端日志是否有错误
3. 确认迁移脚本是否成功运行

### 问题3：上传新图片后图库中看不到

**解决**：
1. 检查后端日志，查看是否有 "写入图片索引失败" 的错误
2. 检查数据库连接是否正常
3. 查看 `image_index` 表是否有新记录

## 三、跨平台编译（可选）

如果需要在 Windows 上编译 Linux 版本用于生产服务器：

```bash
# Windows PowerShell
$env:GOOS="linux"
$env:GOARCH="amd64"
go build -o migrate_images_linux cmd/migrate_images/main.go

# Windows CMD
set GOOS=linux
set GOARCH=amd64
go build -o migrate_images_linux cmd/migrate_images/main.go
```

编译完成后，将 `migrate_images_linux` 上传到 Linux 服务器即可运行。

## 后续优化建议

1. **定期同步**：可以设置定时任务，定期扫描 MinIO 并同步数据库（处理手动上传的文件）
2. **图片尺寸信息**：迁移脚本未获取图片尺寸，可以在后续优化中添加
3. **搜索功能**：数据库方案支持按文件名搜索，可以在前端添加搜索功能

## 技术支持

如有问题，请检查：
1. 后端日志：查看详细的错误信息
2. 数据库日志：检查是否有 SQL 错误
3. MinIO 日志：检查存储服务是否正常

