# 订单全流程测试用例

## 测试环境准备

### 前置条件
1. **用户角色**
   - 小程序用户（客户）
   - 销售员（员工端）
   - 配送员（员工端）
   - 管理员（后台）

2. **测试数据**
   - 至少2个商品（不同规格）
   - 至少1个客户地址
   - 至少1个优惠券（可选）
   - 至少1个销售员账号

3. **测试账号**
   - 小程序用户账号：`test_user`
   - 销售员账号：`test_sales`（员工码：`S001`）
   - 配送员账号：`test_delivery`（员工码：`D001`）

---

## 一、订单创建流程测试

### 1.1 小程序用户自己下单

#### 测试用例 TC-001：正常下单流程
**测试步骤：**
1. 小程序用户登录
2. 添加商品A（数量2）到采购单
3. 添加商品B（数量1）到采购单
4. 进入结算页面，选择收货地址
5. 选择优惠券（可选）
6. 提交订单

**预期结果：**
- ✅ 订单创建成功，订单号生成
- ✅ 订单状态为 `pending_delivery`（待配送）
- ✅ 订单金额计算正确（商品金额 + 配送费 - 优惠券 - 积分）
- ✅ 采购单中的商品被删除（已下单的商品从采购单移除）
- ✅ 优惠券状态更新为已使用（如果使用了优惠券）
- ✅ 小程序端显示订单详情

**验证点：**
- 订单表 `orders` 中新增一条记录
- 订单明细表 `order_items` 中有对应的商品记录
- 采购单表 `purchase_list_items` 中对应商品被删除
- 小程序端采购单为空或只包含未下单的商品

---

#### 测试用例 TC-002：部分商品下单
**测试步骤：**
1. 小程序用户登录
2. 添加商品A（数量2）到采购单
3. 添加商品B（数量1）到采购单
4. 添加商品C（数量3）到采购单
5. 进入结算页面，选择收货地址
6. 选择商品A和商品B（通过 `item_ids` 参数）
7. 提交订单

**预期结果：**
- ✅ 订单创建成功，只包含商品A和商品B
- ✅ 采购单中商品A和商品B被删除
- ✅ 采购单中商品C仍然存在

**验证点：**
- 订单明细中只有商品A和商品B
- 采购单中只有商品C

---

#### 测试用例 TC-003：下单时使用优惠券
**测试步骤：**
1. 小程序用户登录
2. 添加商品到采购单（总金额100元）
3. 进入结算页面，选择收货地址
4. 选择优惠券（满100减10元）
5. 提交订单

**预期结果：**
- ✅ 订单创建成功
- ✅ 订单金额 = 100 - 10 = 90元
- ✅ 优惠券状态更新为已使用
- ✅ 优惠券使用记录创建

**验证点：**
- 订单表 `coupon_discount` 字段为 10
- 订单表 `total_amount` 字段为 90
- 优惠券表 `coupons` 中对应记录状态为已使用

---

#### 测试用例 TC-004：下单时使用积分抵扣
**测试步骤：**
1. 小程序用户登录（账户有100积分）
2. 添加商品到采购单（总金额100元）
3. 进入结算页面，选择收货地址
4. 使用积分抵扣（50积分 = 5元）
5. 提交订单

**预期结果：**
- ✅ 订单创建成功
- ✅ 订单金额 = 100 - 5 = 95元
- ✅ 用户积分减少50积分
- ✅ 积分使用记录创建

**验证点：**
- 订单表 `points_discount` 字段为 5
- 订单表 `total_amount` 字段为 95
- 用户表 `points` 字段减少50

---

### 1.2 销售员代客下单

#### 测试用例 TC-005：销售员正常开单
**测试步骤：**
1. 销售员登录员工端
2. 进入"销售开单"页面
3. 搜索并选择客户（客户已有采购单：商品A数量2，商品B数量1）
4. 查看客户采购单（此时后端自动备份原始采购单）
5. 在开单页面添加商品C（数量1）
6. 修改商品A数量为3
7. 选择收货地址
8. 提交订单

**预期结果：**
- ✅ 订单创建成功
- ✅ 订单包含：商品A（数量3）、商品B（数量1）、商品C（数量1）
- ✅ **关键验证**：小程序客户的采购单恢复到开单前的状态（商品A数量2，商品B数量1，不包含商品C）
- ✅ 销售员添加的商品C不会出现在客户采购单中
- ✅ 销售员修改的商品A数量不会影响客户采购单

**验证点：**
- 订单明细正确
- 小程序端采购单与开单前完全一致（不多不少）
- 后端日志显示备份和恢复操作

---

#### 测试用例 TC-006：销售员开单时只使用客户原有商品
**测试步骤：**
1. 销售员登录员工端
2. 进入"销售开单"页面
3. 搜索并选择客户（客户已有采购单：商品A数量2，商品B数量1）
4. 查看客户采购单（此时后端自动备份原始采购单）
5. 不添加新商品，不修改数量
6. 选择收货地址
7. 提交订单

**预期结果：**
- ✅ 订单创建成功
- ✅ 订单包含：商品A（数量2）、商品B（数量1）
- ✅ **关键验证**：小程序客户的采购单为空（因为所有商品都已下单）

**验证点：**
- 订单明细正确
- 小程序端采购单为空

---

#### 测试用例 TC-007：销售员开单时添加新商品但未下单
**测试步骤：**
1. 销售员登录员工端
2. 进入"销售开单"页面
3. 搜索并选择客户（客户已有采购单：商品A数量2）
4. 查看客户采购单（此时后端自动备份原始采购单）
5. 添加商品B（数量1）
6. 选择收货地址
7. 只选择商品A提交订单（通过 `item_ids` 参数）

**预期结果：**
- ✅ 订单创建成功，只包含商品A
- ✅ **关键验证**：小程序客户的采购单恢复到开单前的状态（商品A数量2）
- ✅ 销售员添加的商品B不会出现在客户采购单中

**验证点：**
- 订单明细只有商品A
- 小程序端采购单只有商品A（数量2）

---

#### 测试用例 TC-008：销售员开单时客户采购单为空
**测试步骤：**
1. 销售员登录员工端
2. 进入"销售开单"页面
3. 搜索并选择客户（客户采购单为空）
4. 添加商品A（数量2）
5. 添加商品B（数量1）
6. 选择收货地址
7. 提交订单

**预期结果：**
- ✅ 订单创建成功
- ✅ 订单包含：商品A（数量2）、商品B（数量1）
- ✅ **关键验证**：小程序客户的采购单为空（与开单前一致）

**验证点：**
- 订单明细正确
- 小程序端采购单为空

---

## 二、订单修改流程测试

### 2.1 订单锁定机制

#### 测试用例 TC-009：正常锁定订单
**测试步骤：**
1. 销售员登录员工端
2. 进入订单详情页（订单状态为 `pending_delivery`）
3. 点击"修改订单"按钮
4. 系统自动锁定订单

**预期结果：**
- ✅ 订单锁定成功
- ✅ 订单表 `is_locked` 字段为 1
- ✅ 订单表 `locked_by` 字段为当前销售员员工码
- ✅ 订单表 `locked_at` 字段有值
- ✅ 订单详情页显示"订单修改中"
- ✅ 订单详情页按钮变为"取消锁定"和"继续修改"

**验证点：**
- 数据库订单记录锁定状态正确
- 前端显示锁定状态

---

#### 测试用例 TC-010：重复锁定订单（并发测试）
**测试步骤：**
1. 销售员A登录员工端
2. 进入订单详情页（订单状态为 `pending_delivery`）
3. 点击"修改订单"按钮，锁定订单
4. 销售员B同时登录员工端（同一订单）
5. 销售员B尝试点击"修改订单"按钮

**预期结果：**
- ✅ 销售员A锁定成功
- ✅ 销售员B锁定失败，提示"订单正在被其他员工修改中，请稍后再试"
- ✅ 订单仍然被销售员A锁定

**验证点：**
- 数据库订单记录 `locked_by` 为销售员A的员工码
- 销售员B收到错误提示

---

#### 测试用例 TC-011：锁定超时自动解锁
**测试步骤：**
1. 销售员登录员工端
2. 锁定订单（手动修改数据库 `locked_at` 为6分钟前）
3. 另一个销售员尝试锁定同一订单

**预期结果：**
- ✅ 第二个销售员可以成功锁定订单（因为第一个锁定已超时）

**验证点：**
- 数据库订单记录 `locked_by` 更新为第二个销售员的员工码

---

#### 测试用例 TC-012：非待配送状态订单无法锁定
**测试步骤：**
1. 销售员登录员工端
2. 进入订单详情页（订单状态为 `delivering`）
3. 尝试点击"修改订单"按钮

**预期结果：**
- ✅ 锁定失败，提示"订单状态不允许修改（当前状态：delivering）"

**验证点：**
- 订单未锁定
- 前端显示错误提示

---

### 2.2 订单修改流程

#### 测试用例 TC-013：正常修改订单
**测试步骤：**
1. 销售员登录员工端
2. 进入订单详情页（订单状态为 `pending_delivery`）
3. 点击"修改订单"按钮，锁定订单
4. 进入修改订单页面
5. 系统自动同步订单商品到采购单（此时后端自动备份客户原始采购单）
6. 在修改页面添加商品C（数量1）
7. 修改商品A数量为5
8. 删除商品B
9. 修改收货地址
10. 修改备注
11. 点击"保存修改"

**预期结果：**
- ✅ 订单修改成功
- ✅ 订单自动解锁
- ✅ 订单包含：商品A（数量5）、商品C（数量1），不包含商品B
- ✅ **关键验证**：小程序客户的采购单恢复到修改前的状态（与修改前完全一致）
- ✅ 订单地址、备注等字段更新

**验证点：**
- 订单明细正确
- 订单表字段更新
- 小程序端采购单与修改前一致
- 后端日志显示备份和恢复操作

---

#### 测试用例 TC-014：修改订单时添加商品
**测试步骤：**
1. 销售员登录员工端
2. 进入订单详情页（订单状态为 `pending_delivery`）
3. 点击"修改订单"按钮，锁定订单
4. 进入修改订单页面
5. 系统自动同步订单商品到采购单（此时后端自动备份客户原始采购单）
6. 点击"添加商品"按钮
7. 在添加商品页面添加商品D（数量2）
8. 返回修改订单页面
9. 点击"保存修改"

**预期结果：**
- ✅ 订单修改成功，包含新添加的商品D
- ✅ **关键验证**：小程序客户的采购单恢复到修改前的状态
- ✅ 新添加的商品D不会出现在客户采购单中

**验证点：**
- 订单明细包含商品D
- 小程序端采购单与修改前一致

---

#### 测试用例 TC-015：修改订单时客户采购单为空
**测试步骤：**
1. 销售员登录员工端
2. 进入订单详情页（订单状态为 `pending_delivery`）
3. 点击"修改订单"按钮，锁定订单
4. 进入修改订单页面
5. 系统自动同步订单商品到采购单（此时后端自动备份客户原始采购单，备份为空）
6. 在修改页面添加商品A（数量2）
7. 点击"保存修改"

**预期结果：**
- ✅ 订单修改成功，包含商品A
- ✅ **关键验证**：小程序客户的采购单为空（与修改前一致）

**验证点：**
- 订单明细包含商品A
- 小程序端采购单为空

---

#### 测试用例 TC-016：取消修改订单
**测试步骤：**
1. 销售员登录员工端
2. 进入订单详情页（订单状态为 `pending_delivery`）
3. 点击"修改订单"按钮，锁定订单
4. 进入修改订单页面
5. 系统自动同步订单商品到采购单（此时后端自动备份客户原始采购单）
6. 在修改页面添加商品C（数量1）
7. 点击"取消修改"按钮
8. 确认取消

**预期结果：**
- ✅ 订单解锁成功
- ✅ 返回订单详情页
- ✅ **关键验证**：小程序客户的采购单恢复到修改前的状态（不包含商品C）
- ✅ 订单内容未改变

**验证点：**
- 订单表 `is_locked` 字段为 0
- 订单内容未改变
- 小程序端采购单与修改前一致

---

#### 测试用例 TC-017：修改订单时退出页面
**测试步骤：**
1. 销售员登录员工端
2. 进入订单详情页（订单状态为 `pending_delivery`）
3. 点击"修改订单"按钮，锁定订单
4. 进入修改订单页面
5. 系统自动同步订单商品到采购单（此时后端自动备份客户原始采购单）
6. 在修改页面添加商品C（数量1）
7. 点击返回按钮退出页面

**预期结果：**
- ✅ 订单自动解锁（页面销毁时自动解锁）
- ✅ **关键验证**：小程序客户的采购单恢复到修改前的状态（不包含商品C）
- ✅ 订单内容未改变

**验证点：**
- 订单表 `is_locked` 字段为 0
- 订单内容未改变
- 小程序端采购单与修改前一致

---

#### 测试用例 TC-018：修改订单时应用进入后台
**测试步骤：**
1. 销售员登录员工端
2. 进入订单详情页（订单状态为 `pending_delivery`）
3. 点击"修改订单"按钮，锁定订单
4. 进入修改订单页面
5. 系统自动同步订单商品到采购单（此时后端自动备份客户原始采购单）
6. 在修改页面添加商品C（数量1）
7. 将应用切换到后台

**预期结果：**
- ✅ 订单自动解锁（应用进入后台时自动解锁）
- ✅ **关键验证**：小程序客户的采购单恢复到修改前的状态（不包含商品C）

**验证点：**
- 订单表 `is_locked` 字段为 0
- 小程序端采购单与修改前一致

---

### 2.3 订单详情页按钮状态

#### 测试用例 TC-019：订单未锁定时的按钮显示
**测试步骤：**
1. 销售员登录员工端
2. 进入订单详情页（订单状态为 `pending_delivery`，未锁定）

**预期结果：**
- ✅ 显示"取消订单"按钮
- ✅ 显示"修改订单"按钮
- ✅ 两个按钮都可以点击

**验证点：**
- 按钮显示正确
- 按钮可点击

---

#### 测试用例 TC-020：订单已锁定时的按钮显示
**测试步骤：**
1. 销售员A登录员工端
2. 进入订单详情页（订单状态为 `pending_delivery`）
3. 点击"修改订单"按钮，锁定订单
4. 销售员B登录员工端（同一订单）
5. 进入订单详情页

**预期结果：**
- ✅ 显示"取消锁定"按钮（如果销售员B是锁定者，按钮可点击）
- ✅ 显示"继续修改"按钮（如果销售员B是锁定者，按钮可点击）
- ✅ 如果销售员B不是锁定者，按钮显示但不可点击，提示"订单正在被其他员工修改中"

**验证点：**
- 按钮显示和状态正确

---

## 三、订单状态流转测试

### 3.1 正常状态流转

#### 测试用例 TC-021：完整订单流程
**测试步骤：**
1. 创建订单（状态：`pending_delivery`）
2. 配送员接单（状态：`pending_delivery` → `pending_pickup`）
3. 配送员开始配送（状态：`pending_pickup` → `delivering`）
4. 配送员送达（状态：`delivering` → `delivered`）
5. 管理员收款（状态：`delivered` → `paid`）

**预期结果：**
- ✅ 每个状态流转都成功
- ✅ 订单状态正确更新
- ✅ 状态流转记录正确

**验证点：**
- 订单表 `status` 字段正确更新
- 状态流转日志正确

---

#### 测试用例 TC-022：待配送状态流转到待取货
**测试步骤：**
1. 创建订单（状态：`pending_delivery`）
2. 配送员接单，更新状态为 `pending_pickup`

**预期结果：**
- ✅ 状态流转成功
- ✅ 订单表 `delivery_employee_code` 字段更新为配送员员工码

**验证点：**
- 订单状态为 `pending_pickup`
- 配送员员工码正确

---

#### 测试用例 TC-023：待取货状态流转到配送中
**测试步骤：**
1. 订单状态为 `pending_pickup`
2. 配送员开始配送，更新状态为 `delivering`

**预期结果：**
- ✅ 状态流转成功

**验证点：**
- 订单状态为 `delivering`

---

#### 测试用例 TC-024：配送中状态流转到已送达
**测试步骤：**
1. 订单状态为 `delivering`
2. 配送员送达，更新状态为 `delivered`

**预期结果：**
- ✅ 状态流转成功

**验证点：**
- 订单状态为 `delivered`

---

#### 测试用例 TC-025：已送达状态流转到已收款
**测试步骤：**
1. 订单状态为 `delivered`
2. 管理员收款，更新状态为 `paid`

**预期结果：**
- ✅ 状态流转成功
- ✅ 订单状态为最终状态，不能再流转

**验证点：**
- 订单状态为 `paid`
- 尝试再次流转状态失败

---

### 3.2 订单取消流程

#### 测试用例 TC-026：待配送状态取消订单
**测试步骤：**
1. 创建订单（状态：`pending_delivery`）
2. 销售员在订单详情页点击"取消订单"
3. 确认取消

**预期结果：**
- ✅ 订单状态更新为 `cancelled`
- ✅ 订单状态为最终状态，不能再流转
- ✅ 优惠券退回（如果使用了优惠券）
- ✅ 积分退回（如果使用了积分）

**验证点：**
- 订单状态为 `cancelled`
- 优惠券状态恢复
- 用户积分恢复

---

#### 测试用例 TC-027：待取货状态取消订单
**测试步骤：**
1. 订单状态为 `pending_pickup`
2. 销售员在订单详情页点击"取消订单"
3. 确认取消

**预期结果：**
- ✅ 订单状态更新为 `cancelled`
- ✅ 订单状态为最终状态，不能再流转

**验证点：**
- 订单状态为 `cancelled`

---

#### 测试用例 TC-028：配送中状态无法取消订单
**测试步骤：**
1. 订单状态为 `delivering`
2. 销售员在订单详情页尝试点击"取消订单"

**预期结果：**
- ✅ 取消按钮不显示或不可点击
- ✅ 提示"配送中不能取消订单"

**验证点：**
- 订单状态未改变
- 前端提示正确

---

#### 测试用例 TC-029：已送达状态无法取消订单
**测试步骤：**
1. 订单状态为 `delivered`
2. 销售员在订单详情页尝试点击"取消订单"

**预期结果：**
- ✅ 取消按钮不显示或不可点击

**验证点：**
- 订单状态未改变

---

#### 测试用例 TC-030：已收款状态无法取消订单
**测试步骤：**
1. 订单状态为 `paid`
2. 销售员在订单详情页尝试点击"取消订单"

**预期结果：**
- ✅ 取消按钮不显示或不可点击

**验证点：**
- 订单状态未改变

---

### 3.3 非法状态流转

#### 测试用例 TC-031：跳过状态流转
**测试步骤：**
1. 订单状态为 `pending_delivery`
2. 尝试直接更新状态为 `delivering`（跳过 `pending_pickup`）

**预期结果：**
- ✅ 状态流转失败，提示"状态流转不合法"

**验证点：**
- 订单状态未改变
- 错误提示正确

---

#### 测试用例 TC-032：反向状态流转
**测试步骤：**
1. 订单状态为 `delivering`
2. 尝试更新状态为 `pending_pickup`（反向流转）

**预期结果：**
- ✅ 状态流转失败，提示"状态流转不合法"

**验证点：**
- 订单状态未改变
- 错误提示正确

---

#### 测试用例 TC-033：最终状态无法流转
**测试步骤：**
1. 订单状态为 `paid`
2. 尝试更新状态为 `delivered`

**预期结果：**
- ✅ 状态流转失败，提示"状态流转不合法"

**验证点：**
- 订单状态未改变
- 错误提示正确

---

## 四、采购单备份和恢复测试

### 4.1 销售员开单时的备份和恢复

#### 测试用例 TC-034：开单时备份和恢复
**测试步骤：**
1. 小程序用户添加商品A（数量2）到采购单
2. 小程序用户添加商品B（数量1）到采购单
3. 销售员进入开单页面，查看客户采购单（此时后端自动备份）
4. 销售员添加商品C（数量1）
5. 销售员修改商品A数量为5
6. 销售员提交订单（包含商品A、B、C）

**预期结果：**
- ✅ 订单创建成功
- ✅ **关键验证**：小程序用户的采购单恢复到步骤3的状态（商品A数量2，商品B数量1，不包含商品C）
- ✅ 后端日志显示备份和恢复操作

**验证点：**
- 小程序端采购单与步骤3完全一致
- 后端日志正确

---

#### 测试用例 TC-035：开单时未传入备份数据
**测试步骤：**
1. 小程序用户添加商品A（数量2）到采购单
2. 销售员进入开单页面，查看客户采购单（此时后端自动备份）
3. 销售员添加商品C（数量1）
4. 销售员提交订单（前端未传入备份数据）

**预期结果：**
- ✅ 订单创建成功
- ✅ 后端自动创建备份（可能包含销售员添加的商品）
- ✅ 后端日志显示警告："前端未传入备份数据，使用创建订单前的备份（可能包含销售员添加的商品，恢复后可能不准确）"
- ✅ 采购单恢复（可能不准确）

**验证点：**
- 后端日志显示警告
- 采购单恢复（可能包含销售员添加的商品）

---

### 4.2 销售员修改订单时的备份和恢复

#### 测试用例 TC-036：修改订单时备份和恢复
**测试步骤：**
1. 小程序用户添加商品A（数量2）到采购单
2. 销售员创建订单（包含商品A）
3. 小程序用户添加商品B（数量1）到采购单
4. 销售员进入修改订单页面（此时后端自动备份客户原始采购单：商品B）
5. 系统同步订单商品到采购单（采购单变为：商品A）
6. 销售员添加商品C（数量1）
7. 销售员保存修改

**预期结果：**
- ✅ 订单修改成功
- ✅ **关键验证**：小程序用户的采购单恢复到步骤4的状态（商品B数量1，不包含商品A和商品C）
- ✅ 后端日志显示备份和恢复操作

**验证点：**
- 小程序端采购单与步骤4完全一致
- 后端日志正确

---

#### 测试用例 TC-037：修改订单时客户采购单为空
**测试步骤：**
1. 销售员创建订单（包含商品A）
2. 小程序用户采购单为空
3. 销售员进入修改订单页面（此时后端自动备份客户原始采购单：空）
4. 系统同步订单商品到采购单（采购单变为：商品A）
5. 销售员添加商品B（数量1）
6. 销售员保存修改

**预期结果：**
- ✅ 订单修改成功
- ✅ **关键验证**：小程序用户的采购单为空（与步骤3一致）

**验证点：**
- 小程序端采购单为空

---

#### 测试用例 TC-038：修改订单时未传入备份数据
**测试步骤：**
1. 小程序用户添加商品A（数量2）到采购单
2. 销售员创建订单（包含商品A）
3. 小程序用户添加商品B（数量1）到采购单
4. 销售员进入修改订单页面（此时后端自动备份客户原始采购单：商品B）
5. 系统同步订单商品到采购单（采购单变为：商品A）
6. 销售员保存修改（前端未传入备份数据）

**预期结果：**
- ✅ 订单修改成功
- ✅ 后端日志显示警告："前端未传入备份数据，直接清空采购单（可能不准确）"
- ✅ 采购单被清空（可能不准确）

**验证点：**
- 后端日志显示警告
- 采购单被清空

---

## 五、边界情况和异常测试

### 5.1 并发测试

#### 测试用例 TC-039：并发下单
**测试步骤：**
1. 小程序用户添加商品A（数量10）到采购单
2. 同时发起两个下单请求（都包含商品A数量10）

**预期结果：**
- ✅ 只有一个订单创建成功
- ✅ 另一个订单创建失败（库存不足或商品已被下单）

**验证点：**
- 只有一个订单创建成功
- 采购单中商品A数量正确

---

#### 测试用例 TC-040：并发修改订单
**测试步骤：**
1. 订单状态为 `pending_delivery`，未锁定
2. 销售员A和销售员B同时尝试锁定订单

**预期结果：**
- ✅ 只有一个销售员锁定成功
- ✅ 另一个销售员锁定失败

**验证点：**
- 订单只被一个销售员锁定

---

### 5.2 异常情况测试

#### 测试用例 TC-041：订单创建时商品库存不足
**测试步骤：**
1. 小程序用户添加商品A（数量100）到采购单
2. 商品A库存只有50
3. 提交订单

**预期结果：**
- ✅ 订单创建失败或部分创建
- ✅ 根据 `out_of_stock_strategy` 处理缺货商品

**验证点：**
- 订单创建失败或部分创建
- 缺货处理策略正确执行

---

#### 测试用例 TC-042：订单创建时网络中断
**测试步骤：**
1. 小程序用户添加商品到采购单
2. 提交订单时网络中断

**预期结果：**
- ✅ 订单创建失败
- ✅ 采购单未改变（商品仍在采购单中）

**验证点：**
- 订单未创建
- 采购单未改变

---

#### 测试用例 TC-043：修改订单时订单被删除
**测试步骤：**
1. 销售员进入修改订单页面
2. 订单被管理员删除（模拟）
3. 销售员尝试保存修改

**预期结果：**
- ✅ 保存失败，提示"订单不存在"

**验证点：**
- 保存失败
- 错误提示正确

---

#### 测试用例 TC-044：修改订单时订单状态改变
**测试步骤：**
1. 销售员进入修改订单页面（订单状态为 `pending_delivery`）
2. 订单状态被其他操作改为 `delivering`（模拟）
3. 销售员尝试保存修改

**预期结果：**
- ✅ 保存失败，提示"订单状态不允许修改"

**验证点：**
- 保存失败
- 错误提示正确

---

### 5.3 数据一致性测试

#### 测试用例 TC-045：订单金额计算准确性
**测试步骤：**
1. 创建订单，包含多个商品
2. 使用优惠券
3. 使用积分抵扣
4. 计算订单总金额

**预期结果：**
- ✅ 订单总金额 = 商品金额 + 配送费 - 优惠券金额 - 积分抵扣金额
- ✅ 所有金额字段计算正确

**验证点：**
- 订单表所有金额字段正确
- 计算公式正确

---

#### 测试用例 TC-046：订单明细与订单主表一致性
**测试步骤：**
1. 创建订单，包含多个商品
2. 检查订单主表和订单明细表

**预期结果：**
- ✅ 订单主表 `goods_amount` = 订单明细表所有商品金额之和
- ✅ 订单明细表所有记录 `order_id` 正确

**验证点：**
- 数据一致性正确

---

## 六、性能测试

### 6.1 大量数据测试

#### 测试用例 TC-047：大量商品下单
**测试步骤：**
1. 小程序用户添加100个不同商品到采购单
2. 提交订单

**预期结果：**
- ✅ 订单创建成功
- ✅ 响应时间在可接受范围内（< 3秒）

**验证点：**
- 订单创建成功
- 响应时间合理

---

#### 测试用例 TC-048：大量订单查询
**测试步骤：**
1. 系统中有10000个订单
2. 查询订单列表（分页）

**预期结果：**
- ✅ 查询成功
- ✅ 响应时间在可接受范围内（< 2秒）

**验证点：**
- 查询成功
- 响应时间合理

---

## 七、测试检查清单

### 7.1 功能检查清单

- [ ] 小程序用户自己下单功能正常
- [ ] 销售员代客下单功能正常
- [ ] 订单修改功能正常
- [ ] 订单锁定机制正常
- [ ] 订单状态流转正常
- [ ] 订单取消功能正常
- [ ] 采购单备份和恢复机制正常
- [ ] 优惠券使用正常
- [ ] 积分抵扣正常

### 7.2 数据一致性检查清单

- [ ] 订单创建后，采购单正确更新
- [ ] 销售员开单后，客户采购单恢复到开单前状态
- [ ] 销售员修改订单后，客户采购单恢复到修改前状态
- [ ] 订单金额计算正确
- [ ] 订单明细与订单主表一致

### 7.3 边界情况检查清单

- [ ] 并发下单处理正确
- [ ] 并发修改订单处理正确
- [ ] 库存不足处理正确
- [ ] 网络中断处理正确
- [ ] 订单状态异常处理正确

### 7.4 用户体验检查清单

- [ ] 订单创建提示清晰
- [ ] 订单修改提示清晰
- [ ] 订单锁定提示清晰
- [ ] 错误提示清晰
- [ ] 加载状态显示正确

---

## 八、测试数据准备

### 8.1 商品数据
```sql
-- 商品A
INSERT INTO products (name, price, stock) VALUES ('商品A', 100.00, 1000);

-- 商品B
INSERT INTO products (name, price, stock) VALUES ('商品B', 200.00, 500);

-- 商品C
INSERT INTO products (name, price, stock) VALUES ('商品C', 300.00, 300);
```

### 8.2 用户数据
```sql
-- 小程序用户
INSERT INTO mini_app_users (name, phone, sales_code) VALUES ('测试用户', '13800138000', 'S001');

-- 销售员
INSERT INTO employees (employee_code, name, is_sales) VALUES ('S001', '测试销售员', 1);
```

### 8.3 地址数据
```sql
-- 收货地址
INSERT INTO user_addresses (user_id, name, phone, address) VALUES (1, '测试用户', '13800138000', '测试地址');
```

---

## 九、测试报告模板

### 测试执行记录

| 测试用例ID | 测试用例名称 | 执行结果 | 执行时间 | 备注 |
|-----------|------------|---------|---------|------|
| TC-001 | 正常下单流程 | ✅ 通过 | 2024-XX-XX | |
| TC-002 | 部分商品下单 | ✅ 通过 | 2024-XX-XX | |
| ... | ... | ... | ... | ... |

### 问题记录

| 问题ID | 测试用例ID | 问题描述 | 严重程度 | 状态 |
|-------|-----------|---------|---------|------|
| BUG-001 | TC-005 | 销售员开单后，客户采购单多出商品 | 高 | 已修复 |
| ... | ... | ... | ... | ... |

---

## 十、测试注意事项

1. **测试环境隔离**：确保测试环境与生产环境隔离，避免影响真实数据
2. **数据清理**：每次测试前清理测试数据，确保测试结果准确
3. **日志检查**：测试时检查后端日志，确认备份和恢复操作正确执行
4. **并发测试**：使用工具模拟并发请求，测试系统并发处理能力
5. **数据验证**：测试后验证数据库数据，确保数据一致性
6. **用户体验**：测试时关注用户体验，确保操作流程顺畅

---

## 附录：关键验证点总结

### 采购单备份和恢复机制验证点

1. **销售员开单时**：
   - ✅ 在 `GetSalesCustomerPurchaseList` 中备份客户原始采购单
   - ✅ 在 `CreateOrderForCustomer` 中接收备份数据并恢复
   - ✅ 客户采购单恢复到开单前状态（不多不少）

2. **销售员修改订单时**：
   - ✅ 在 `SyncOrderItemsToPurchaseList` 中备份客户原始采购单
   - ✅ 在 `UpdateOrderForCustomer` 中接收备份数据并恢复
   - ✅ 客户采购单恢复到修改前状态（不多不少）

3. **小程序用户自己下单时**：
   - ✅ 不下单的商品保留在采购单中
   - ✅ 已下单的商品从采购单中删除
   - ✅ 不使用备份和恢复机制

### 订单锁定机制验证点

1. **锁定时机**：
   - ✅ 点击"修改订单"按钮时锁定
   - ✅ 只有 `pending_delivery` 状态可以锁定

2. **解锁时机**：
   - ✅ 保存修改后自动解锁
   - ✅ 取消修改后自动解锁
   - ✅ 退出页面时自动解锁
   - ✅ 应用进入后台时自动解锁
   - ✅ 锁定超时（5分钟）自动解锁

3. **并发控制**：
   - ✅ 使用数据库行锁确保原子性
   - ✅ 同一时间只能有一个销售员锁定订单

---

**文档版本**：v1.0  
**最后更新**：2024-12-14  
**维护人员**：开发团队

