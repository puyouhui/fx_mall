# 小程序登录触发位置说明

## 一、登录组件和API

### 1. 登录组件
- **`components/LoginModal.vue`** - 登录弹窗组件
  - 通过 `performMiniLogin()` 方法执行登录
  - 调用 `uni.login()` 获取 code
  - 调用 `miniLogin()` API 进行登录

### 2. 登录API
- **`api/index.js`** - `miniLogin(code, referrerId)` 函数
  - 接收微信登录 code 和分享者ID（可选）
  - 返回用户信息和 token

---

## 二、触发登录的具体位置

### 1. **我的页面** (`pages/my/my.vue`)
触发场景：
- **页面加载时** - `onLoad()` 和 `onShow()` 检查登录状态
- **点击"点击登录"按钮** - `goToLogin()` 显示登录弹窗
- **个人资料** - `goToProfile()` 未登录时触发登录
- **订单列表** - `goToOrderList()` 未登录时触发登录
- **客服页面** - `goToCustomerService()` 未登录时触发登录
- **优惠券页面** - `goToCoupons()` 未登录时触发登录
- **积分明细** - `goToPointsLogs()` 未登录时触发登录

### 2. **商品选择器** (`components/ProductSelector.vue`)
触发场景：
- **打开商品选择器时** - `ensureUserReady()` 检查用户是否登录
- **添加到采购单时** - 如果未登录，会自动调用 `ensureMiniUserInfo()` 进行登录
- **需要完善资料时** - 如果已登录但未完善资料，会跳转到资料填写页面

### 3. **商品详情页** (`pages/product/detail.vue`)
触发场景：
- **添加到采购单** - `addSpecToCart()` 方法中调用 `ensureUserLoggedIn()` 检查登录
- **点击登录按钮** - `goToLogin()` 方法（如果存在）

### 4. **订单确认页** (`pages/order/confirm.vue`)
触发场景：
- **页面加载时** - `onLoad()` 检查 token，未登录时提示并返回

### 5. **购物车/采购单** (`pages/cart/cart.vue`)
触发场景：
- **页面显示时** - `onShow()` 调用 `loadCart()`，需要 token
- **加载采购单数据** - `loadCart()` 方法中检查 token，无 token 时清空数据

### 6. **收藏页面** (`pages/favorites/favorites.vue`)
触发场景：
- **加载收藏列表** - `loadFavorites()` 方法中检查 token
- **删除收藏** - `deleteFavorite()` 方法中检查 token

### 7. **地址管理** (`pages/address/address.vue`)
触发场景：
- **页面加载时** - `onLoad()` 检查 token，未登录时提示并返回

### 8. **优惠券页面** (`pages/coupons/coupons.vue`)
触发场景：
- **页面加载时** - `onLoad()` 检查 token，未登录时提示并返回

### 9. **积分明细** (`pages/points/logs.vue`)
触发场景：
- **页面加载时** - 检查登录状态，未登录时提示并跳转到登录页

### 10. **个人资料** (`pages/profile/profile.vue`)
触发场景：
- **多个操作** - 需要登录才能访问和操作

### 11. **身份选择** (`pages/identity/select.vue`)
触发场景：
- **页面加载时** - 检查登录状态

### 12. **资料填写** (`pages/profile/form.vue`)
触发场景：
- **页面加载时** - 检查登录状态
- **提交资料时** - 检查登录状态

### 13. **订单列表** (`pages/order/list.vue`)
触发场景：
- **页面加载时** - 需要登录才能查看订单

### 14. **设置页面** (`pages/settings/settings.vue`)
触发场景：
- **页面加载时** - `checkLoginStatus()` 检查登录状态
- **退出登录** - `logout()` 清除登录信息

### 15. **价格反馈** (`pages/price-feedback/price-feedback.vue`)
触发场景：
- **提交反馈时** - 检查登录状态

### 16. **商品申请** (`pages/product-request/product-request.vue`)
触发场景：
- **提交申请时** - 检查登录状态

### 17. **发票页面** (`pages/invoice/invoice.vue`)
触发场景：
- **页面加载时** - 检查登录状态

### 18. **推荐奖励** (`pages/referral/referral.vue`)
触发场景：
- **查看推荐信息时** - 检查登录状态

### 19. **搜索页面** (`pages/search/search.vue`)
触发场景：
- **某些操作** - 可能需要登录（根据具体功能）

---

## 三、登录检查方式

### 1. 直接检查 token
```javascript
const token = uni.getStorageSync('miniUserToken');
if (!token) {
  uni.showToast({ title: '请先登录', icon: 'none' });
  // 或显示登录弹窗
  // 或返回上一页
}
```

### 2. 使用登录弹窗
```javascript
// 在 my.vue 中
this.showLoginModal = true; // 显示 LoginModal 组件
```

### 3. 自动登录（ProductSelector）
```javascript
// 在 ProductSelector.vue 中
const state = await ensureMiniUserInfo(); // 自动执行登录
```

### 4. API 请求拦截
- **`api/request.js`** - 请求拦截器中检查 token
- 如果 token 过期或无效，会自动清除本地登录信息

---

## 四、登录流程

1. **用户触发** - 点击需要登录的功能
2. **检查登录状态** - 检查 `miniUserToken` 是否存在
3. **显示登录弹窗** - 如果未登录，显示 `LoginModal` 组件
4. **执行登录** - 调用 `uni.login()` 获取 code
5. **调用登录API** - 使用 code 调用 `miniLogin()` API
6. **保存登录信息** - 保存 `miniUserToken`、`miniUserInfo`、`miniUserUniqueId`
7. **刷新页面数据** - 登录成功后刷新相关数据

---

## 五、注意事项

1. **分享者ID** - 登录时会检查并传递 `shareReferrerId`（如果存在）
2. **资料完善** - 某些功能需要用户完善资料后才能使用
3. **Token 过期** - API 请求失败时会自动清除登录信息
4. **自动登录** - `ProductSelector` 组件会自动执行登录，无需用户手动操作
