# 推荐奖励活动功能实现说明

## 功能概述

实现了老用户推荐新用户首次下单奖励功能。当老用户分享小程序链接给新用户，新用户首次下单且订单完成付款后，系统会自动给老用户发放奖励。

## 功能特点

1. **自动检测首次下单**：系统会自动检测用户是否是首次下单
2. **自动记录推荐关系**：如果新用户有referrer_id（通过分享链接进入），系统会在首次下单时记录推荐奖励
3. **订单完成付款后发放**：只有当订单状态变为`paid`（已收款）时，才会发放奖励给老用户
4. **支持多种奖励类型**：支持积分、优惠券、金额三种奖励类型
5. **后台管理配置**：可以在后台营销管理中配置活动参数和查看奖励记录

## 数据库表结构

### 1. referral_reward_config（活动配置表）

- `id`: 主键
- `is_enabled`: 是否启用（0-禁用，1-启用）
- `reward_type`: 奖励类型（points/coupon/amount）
- `reward_value`: 奖励值（积分数量/金额）
- `coupon_id`: 优惠券ID（当reward_type为coupon时使用）
- `description`: 活动说明
- `created_at`: 创建时间
- `updated_at`: 更新时间

### 2. referral_rewards（奖励记录表）

- `id`: 主键
- `referrer_id`: 推荐人用户ID（老用户）
- `new_user_id`: 新用户ID
- `order_id`: 订单ID（新用户首次下单的订单）
- `order_number`: 订单编号
- `reward_type`: 奖励类型
- `reward_value`: 奖励值
- `coupon_id`: 优惠券ID
- `status`: 状态（pending-待发放，completed-已发放，failed-发放失败）
- `reward_at`: 奖励发放时间
- `remark`: 备注
- `created_at`: 创建时间
- `updated_at`: 更新时间

## 业务流程

### 1. 订单创建时

- 系统检查用户是否是首次下单（`CheckIsFirstOrder`）
- 如果是首次下单，检查用户是否有`referrer_id`
- 如果有`referrer_id`，创建推荐奖励记录（状态为`pending`）

### 2. 订单完成付款时

- 当订单状态变为`paid`时，系统调用`ProcessReferralReward`
- 系统查找该订单的所有待发放奖励记录
- 根据活动配置的奖励类型，发放奖励：
  - **积分**：直接增加用户积分
  - **优惠券**：发放一张指定的优惠券
  - **金额**：记录到备注中（可根据业务需求实现实际发放逻辑）
- 更新奖励记录状态为`completed`或`failed`

## 后端API接口

### 1. 获取活动配置
- **路径**：`GET /admin/referral-reward/config`
- **说明**：获取当前推荐奖励活动配置

### 2. 更新活动配置
- **路径**：`PUT /admin/referral-reward/config`
- **参数**：
  - `id`: 配置ID
  - `is_enabled`: 是否启用
  - `reward_type`: 奖励类型（points/coupon/amount）
  - `reward_value`: 奖励值
  - `coupon_id`: 优惠券ID（当reward_type为coupon时必填）
  - `description`: 活动说明

### 3. 获取奖励记录列表
- **路径**：`GET /admin/referral-reward/rewards`
- **参数**：
  - `page_num`: 页码（默认1）
  - `page_size`: 每页数量（默认10）
  - `referrer_id`: 推荐人ID（可选）
  - `new_user_id`: 新用户ID（可选）
  - `status`: 状态筛选（pending/completed/failed，可选）

## 前端页面

### 位置
- **路径**：`/referral-reward`
- **菜单**：营销管理 > 推荐奖励活动

### 功能
1. **活动配置**：
   - 启用/禁用活动
   - 选择奖励类型（积分/优惠券/金额）
   - 设置奖励值
   - 选择优惠券（当奖励类型为优惠券时）
   - 填写活动说明

2. **奖励记录**：
   - 查看所有奖励记录
   - 按状态筛选（待发放/已发放/发放失败）
   - 查看推荐人、新用户、订单号等信息
   - 查看奖励发放时间

## 代码文件

### 后端
- `go_backend/internal/database/database.go`: 数据库表创建
- `go_backend/internal/model/referral_reward.go`: 数据模型和业务逻辑
- `go_backend/internal/api/referral_reward.go`: API接口
- `go_backend/internal/model/order.go`: 订单创建时检查首次下单
- `go_backend/internal/api/order_admin.go`: 订单状态更新时处理奖励
- `go_backend/cmd/main.go`: 路由注册

### 前端
- `admin_console/src/views/ReferralReward.vue`: 活动配置和奖励记录页面
- `admin_console/src/api/referralReward.js`: API调用
- `admin_console/src/router/index.js`: 路由配置
- `admin_console/src/layout/Layout.vue`: 菜单配置

## 注意事项

1. **首次下单判断**：系统通过检查用户是否有非取消状态的订单来判断是否是首次下单
2. **奖励发放时机**：只有在订单状态变为`paid`（已收款）时才会发放奖励
3. **重复记录防护**：同一订单同一推荐人只能有一条奖励记录
4. **活动未启用**：如果活动未启用，不会创建奖励记录
5. **奖励发放失败**：如果奖励发放失败，记录状态会更新为`failed`，并记录失败原因

## 使用说明

1. **配置活动**：
   - 进入后台管理 > 营销管理 > 推荐奖励活动
   - 在"活动配置"标签页中配置活动参数
   - 选择奖励类型和设置奖励值
   - 点击"保存配置"

2. **查看奖励记录**：
   - 在"奖励记录"标签页中查看所有奖励记录
   - 可以按状态筛选记录
   - 查看奖励发放情况

3. **活动启用**：
   - 在活动配置中开启"是否启用"开关
   - 保存配置后，活动立即生效

## 后续扩展建议

1. **金额奖励实际发放**：如果使用金额奖励，可以实现实际的余额系统或提现功能
2. **奖励统计**：可以添加推荐人维度的奖励统计功能
3. **奖励通知**：可以在奖励发放成功后发送通知给推荐人
4. **奖励规则扩展**：可以支持更复杂的奖励规则，如阶梯奖励、限时奖励等

