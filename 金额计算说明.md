# 金额计算说明文档

本文档详细说明系统中的配送费计算模型和利润计算模型。

---

## 一、配送费计算模型

配送费计算模型用于计算**配送员实际所得**的配送费，包含多个组成部分。

### 1.1 计算组件

配送费由以下部分组成：

#### 1. 基础配送费 (Base Fee)
- **配置项**: `delivery_base_fee`
- **默认值**: 4.0 元
- **说明**: 每单的基础配送费用，固定金额
- **计算公式**: 
  ```
  基础配送费 = max(0, 配置值)
  ```

#### 2. 孤立订单补贴 (Isolated Fee)
- **配置项**: 
  - `delivery_isolated_subsidy` (补贴金额，默认 3.0 元)
  - `delivery_isolated_distance` (孤立距离阈值，默认 8.0 公里)
- **说明**: 当订单地址周围指定距离内没有其他待配送订单时，给予补贴
- **判断逻辑**:
  - 查询所有状态为 `pending`、`pending_delivery`、`pending_pickup` 的订单
  - 计算这些订单地址与当前订单地址的距离
  - 如果指定距离内没有其他订单，则判定为孤立订单，给予补贴
- **计算公式**:
  ```
  孤立订单补贴 = 如果孤立 ? 补贴金额 : 0
  ```

#### 3. 商品件数补贴 (Item Fee)
- **配置项**:
  - `delivery_item_threshold_low` (低档阈值，默认 5 件)
  - `delivery_item_rate_low` (低档补贴率，默认 0.5 元/件)
  - `delivery_item_threshold_high` (高档阈值，默认 10 件)
  - `delivery_item_rate_high` (高档补贴率，默认 0.6 元/件)
  - `delivery_item_max_count` (最大计件数，默认 50 件)
- **说明**: 根据订单商品件数给予补贴，件数越多补贴越高
- **计算公式**:
  ```
  如果 件数 < 低档阈值:
      件数补贴 = 0
  否则如果 件数 < 高档阈值:
      件数补贴 = 件数 × 低档补贴率
  否则:
      件数补贴 = min(件数, 最大计件数) × 高档补贴率
  ```

#### 4. 加急订单补贴 (Urgent Fee)
- **配置项**: `delivery_urgent_subsidy` (默认 10.0 元)
- **说明**: 当订单标记为加急时，给予固定补贴
- **计算公式**:
  ```
  加急订单补贴 = 如果加急 ? 补贴金额 : 0
  ```

#### 5. 极端天气补贴 (Weather Fee)
- **配置项**:
  - `delivery_weather_subsidy` (补贴金额，默认 1.0 元)
  - `delivery_extreme_temp` (极端温度阈值，默认 37.0°C)
- **说明**: 当订单地址所在地区出现极端天气时，给予补贴
- **判断逻辑**:
  - 获取订单地址的天气信息（温度、天气状况、降水量）
  - 判断是否为极端天气，满足以下任一条件即判定为极端天气：
    1. **雨雪天气**: 天气状况包含"雨"或"雪"（或英文"rain"、"snow"），且降水量 > 0.5mm
    2. **高温天气**: 温度 > 极端温度阈值（默认 37.0°C）
- **计算公式**:
  ```
  极端天气补贴 = 如果极端天气 ? 补贴金额 : 0
  ```
- **注意**: 天气信息优先使用订单创建时存储的数据，避免重复调用外部API

#### 6. 利润分成 (Profit Share)
- **配置项**:
  - `delivery_profit_threshold` (利润阈值，默认 25.0 元)
  - `delivery_profit_share_rate` (分成比例，默认 0.08，即 8%)
  - `delivery_max_profit_share` (最大分成，默认 50.0 元)
- **说明**: 当订单利润超过阈值时，配送员可以获得利润分成
- **计算公式**:
  ```
  如果 订单利润 <= 利润阈值:
      利润分成 = 0
  否则:
      分成基数 = 订单利润 - 配送费（不含利润分成）
      如果 分成基数 <= 0:
          利润分成 = 0
      否则:
          利润分成 = min(max(分成基数 × 分成比例, 0), 最大分成)
  ```
- **注意**: 利润分成仅管理员可见明细，配送员视图中隐藏（但金额已包含在配送员实际所得中）

### 1.2 配送费汇总

#### 不含利润分成的配送费
```
配送费（不含利润分成）= 基础配送费 + 孤立订单补贴 + 商品件数补贴 + 加急订单补贴 + 极端天气补贴
```

#### 配送员实际所得
```
配送员实际所得 = 配送费（不含利润分成）+ 利润分成
```

#### 平台总成本
```
平台总成本 = 配送员实际所得
```

### 1.3 配置项说明

所有配置项都存储在 `system_settings` 表中，可以通过后台管理系统进行配置。

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `delivery_base_fee` | float | 4.0 | 基础配送费（元） |
| `delivery_isolated_subsidy` | float | 3.0 | 孤立订单补贴（元） |
| `delivery_isolated_distance` | float | 8.0 | 孤立距离阈值（公里） |
| `delivery_item_threshold_low` | int | 5 | 件数补贴低档阈值（件） |
| `delivery_item_rate_low` | float | 0.5 | 件数补贴低档补贴率（元/件） |
| `delivery_item_threshold_high` | int | 10 | 件数补贴高档阈值（件） |
| `delivery_item_rate_high` | float | 0.6 | 件数补贴高档补贴率（元/件） |
| `delivery_item_max_count` | int | 50 | 最大计件数（件） |
| `delivery_urgent_subsidy` | float | 10.0 | 加急订单补贴（元） |
| `delivery_weather_subsidy` | float | 1.0 | 极端天气补贴（元） |
| `delivery_extreme_temp` | float | 37.0 | 极端温度阈值（°C） |
| `delivery_profit_threshold` | float | 25.0 | 利润分成阈值（元） |
| `delivery_profit_share_rate` | float | 0.08 | 利润分成比例（8%） |
| `delivery_max_profit_share` | float | 50.0 | 最大利润分成（元） |

---

## 二、利润计算模型

利润计算模型用于计算订单的利润和净利润。

### 2.1 订单利润计算

#### 商品总金额
根据用户类型（批发/零售）计算商品总金额：

```
对于每个商品:
  如果 用户类型 == "wholesale":
      单价 = 批发价（如果批发价 <= 0，则使用零售价）
  否则:
      单价 = 零售价（如果零售价 <= 0，则使用批发价）
  
  如果 单价 <= 0:
      单价 = 成本价
  
  如果 单价 < 0:
      单价 = 0

商品总金额 = Σ(单价 × 数量)
```

#### 总成本
```
对于每个商品:
  成本 = 商品规格的成本价
  如果 成本 < 0:
      成本 = 0

总成本 = Σ(成本 × 数量)
```

#### 订单利润
```
订单利润 = 商品总金额 - 总成本
如果 订单利润 < 0:
    订单利润 = 0
```

**重要说明**：
- **订单利润只考虑商品本身的利润**，不包含配送费、加急费、优惠券等因素
- 客户支付的配送费和加急费是平台的**额外收入**，但不影响商品利润计算
- 优惠券抵扣是平台的**成本**（平台承担），但不影响商品利润计算

### 2.2 订单金额构成

订单的总金额由以下部分组成：

```
实际应付金额 = 商品总金额 + 配送费 + 加急费 - 积分抵扣 - 优惠券抵扣
```

其中：
- **商品总金额** (`goods_amount`): 所有商品的销售金额总和
- **配送费** (`delivery_fee`): 客户支付的配送费（可能为0，如果满足免费配送条件）
- **加急费** (`urgent_fee`): 客户支付的加急费用（如果订单标记为加急）
- **积分抵扣** (`points_discount`): 客户使用积分抵扣的金额
- **优惠券抵扣** (`coupon_discount`): 客户使用优惠券抵扣的金额

### 2.3 净利润计算

```
净利润 = 订单利润 - 平台总成本（配送费）
```

其中：
- **订单利润** = 商品总金额 - 商品总成本（不考虑配送费、加急费、优惠券）
- **平台总成本** = 配送员实际所得（包含利润分成）

**净利润的完整计算逻辑**：

```
净利润 = (商品总金额 - 商品总成本) - 平台总成本（配送费）
       = 订单利润 - 配送员实际所得
```

**注意**：
- 客户支付的配送费和加急费是平台的收入，但不直接参与利润计算
- 优惠券抵扣是平台的成本，但不影响商品利润
- 净利润会减去平台支付给配送员的费用（包括各种补贴和利润分成）

### 2.4 利润分成计算

利润分成是配送费的一部分，计算逻辑见 [1.1.6 利润分成](#16-利润分成-profit-share)。

**利润分成的计算基数**：
```
分成基数 = 订单利润 - 配送费（不含利润分成）
```

注意：利润分成基于**订单利润**（商品利润），而不是基于客户支付的总金额。

---

## 三、客户支付的配送费

客户支付的配送费与配送员实际所得不同，由以下规则决定：

### 3.1 基础规则

#### 基础配送费
- **配置项**: `delivery_fee_settings.base_fee`
- **说明**: 客户需要支付的基础配送费

#### 免费配送阈值
- **配置项**: `delivery_fee_settings.free_shipping_threshold`
- **说明**: 当订单金额达到此阈值时，免收配送费

### 3.2 排除项规则

某些商品或分类可以免配送费，通过 `delivery_fee_exclusions` 表配置：

- **商品级排除**: 指定商品达到一定数量时免配送费
- **分类级排除**: 指定分类的商品达到一定数量时免配送费（支持父分类）

#### 计算逻辑

1. 将采购单商品分为两类：
   - **可计入免费配送的商品** (Eligible): 满足排除项规则的商品
   - **不可计入免费配送的商品** (Ineligible): 不满足排除项规则的商品

2. 计算可计入金额：
   ```
   可计入金额 = Σ(可计入商品的金额)
   ```

3. 判断是否免费配送：
   ```
   如果 可计入金额 >= 免费配送阈值:
      客户支付配送费 = 0
      免费配送 = true
   否则:
      客户支付配送费 = 基础配送费
      免费配送 = false
      还差金额 = 免费配送阈值 - 可计入金额
   ```

### 3.3 客户支付配送费与配送员实际所得的关系

- **客户支付配送费**: 由 `delivery_fee_settings` 和排除项规则决定
- **配送员实际所得**: 由配送费计算模型决定（包含各种补贴和利润分成）
- **两者关系**: 客户支付的配送费可能小于、等于或大于配送员实际所得，差额由平台承担

---

## 四、计算示例

### 示例 1: 普通订单（无加急、无优惠券）

**订单信息**:
- 商品件数: 8 件
- 商品总金额: 100 元
- 商品总成本: 60 元
- 是否加急: 否
- 是否孤立: 是
- 是否极端天气: 否
- 客户支付配送费: 5 元（假设不满足免费配送）
- 加急费: 0 元
- 优惠券抵扣: 0 元

**订单金额构成**:
- 商品总金额 = 100 元
- 配送费 = 5 元
- 加急费 = 0 元
- 优惠券抵扣 = 0 元
- **实际应付金额** = 100 + 5 + 0 - 0 - 0 = 105 元

**订单利润计算**:
- 订单利润 = 100 - 60 = 40 元（只考虑商品利润，不考虑配送费、加急费、优惠券）

**配送费计算**（配送员实际所得）:
1. 基础配送费 = 4.0 元
2. 孤立订单补贴 = 3.0 元
3. 商品件数补贴 = 8 × 0.5 = 4.0 元（8件在低档阈值和高档阈值之间）
4. 加急订单补贴 = 0 元
5. 极端天气补贴 = 0 元
6. 配送费（不含利润分成）= 4.0 + 3.0 + 4.0 = 11.0 元
7. 利润分成:
   - 订单利润 (40) > 利润阈值 (25) ✓
   - 分成基数 = 40 - 11.0 = 29.0 元
   - 利润分成 = 29.0 × 0.08 = 2.32 元
8. 配送员实际所得 = 11.0 + 2.32 = 13.32 元

**净利润计算**:
- 净利润 = 订单利润 - 平台总成本 = 40 - 13.32 = 26.68 元

**平台收支**:
- 平台收入 = 客户支付配送费 = 5 元
- 平台成本 = 配送员实际所得 = 13.32 元
- 平台配送费亏损 = 13.32 - 5 = 8.32 元
- 商品利润 = 40 元
- **平台总利润** = 商品利润 - 配送费亏损 = 40 - 8.32 = 31.68 元
- **净利润** = 26.68 元（与上面计算结果一致）

### 示例 2: 高利润订单（有加急、有优惠券）

**订单信息**:
- 商品件数: 15 件
- 商品总金额: 200 元
- 商品总成本: 80 元
- 是否加急: 是
- 是否孤立: 否
- 是否极端天气: 是
- 客户支付配送费: 0 元（满足免费配送条件）
- 加急费: 15 元（客户支付）
- 优惠券抵扣: 20 元（满减优惠券）

**订单金额构成**:
- 商品总金额 = 200 元
- 配送费 = 0 元（免费配送）
- 加急费 = 15 元
- 优惠券抵扣 = 20 元
- **实际应付金额** = 200 + 0 + 15 - 0 - 20 = 195 元

**订单利润计算**:
- 订单利润 = 200 - 80 = 120 元（只考虑商品利润，不考虑配送费、加急费、优惠券）

**配送费计算**（配送员实际所得）:
1. 基础配送费 = 4.0 元
2. 孤立订单补贴 = 0 元
3. 商品件数补贴 = 15 × 0.6 = 9.0 元（15件超过高档阈值）
4. 加急订单补贴 = 10.0 元（配送员获得的加急补贴，与客户支付的加急费不同）
5. 极端天气补贴 = 1.0 元
6. 配送费（不含利润分成）= 4.0 + 0 + 9.0 + 10.0 + 1.0 = 24.0 元
7. 利润分成:
   - 订单利润 (120) > 利润阈值 (25) ✓
   - 分成基数 = 120 - 24.0 = 96.0 元
   - 利润分成 = min(96.0 × 0.08, 50.0) = min(7.68, 50.0) = 7.68 元
8. 配送员实际所得 = 24.0 + 7.68 = 31.68 元

**净利润计算**:
- 净利润 = 订单利润 - 平台总成本 = 120 - 31.68 = 88.32 元

**平台收支**:
- 平台收入 = 客户支付配送费 + 客户支付加急费 = 0 + 15 = 15 元
- 平台成本 = 配送员实际所得 + 优惠券抵扣 = 31.68 + 20 = 51.68 元
- 平台配送相关亏损 = 51.68 - 15 = 36.68 元
- 商品利润 = 120 元
- **平台总利润** = 商品利润 - 配送相关亏损 = 120 - 36.68 = 83.32 元
- **净利润** = 88.32 元（与上面计算结果一致）

**注意**：
- 客户支付的加急费（15元）是平台收入，但不影响商品利润计算
- 配送员获得的加急补贴（10元）是平台成本，包含在配送员实际所得中
- 优惠券抵扣（20元）是平台成本，但不影响商品利润计算

### 示例 3: 低利润订单（有配送费、无加急、有优惠券）

**订单信息**:
- 商品件数: 3 件
- 商品总金额: 50 元
- 商品总成本: 45 元
- 是否加急: 否
- 是否孤立: 否
- 是否极端天气: 否
- 客户支付配送费: 5 元（不满足免费配送）
- 加急费: 0 元
- 优惠券抵扣: 5 元（配送费优惠券）

**订单金额构成**:
- 商品总金额 = 50 元
- 配送费 = 5 元
- 加急费 = 0 元
- 优惠券抵扣 = 5 元（配送费优惠券，抵扣配送费）
- **实际应付金额** = 50 + 5 + 0 - 0 - 5 = 50 元

**订单利润计算**:
- 订单利润 = 50 - 45 = 5 元（只考虑商品利润，不考虑配送费、加急费、优惠券）

**配送费计算**（配送员实际所得）:
1. 基础配送费 = 4.0 元
2. 孤立订单补贴 = 0 元
3. 商品件数补贴 = 0 元（3件 < 低档阈值5件）
4. 加急订单补贴 = 0 元
5. 极端天气补贴 = 0 元
6. 配送费（不含利润分成）= 4.0 元
7. 订单利润 = 5 元
8. 利润分成:
   - 订单利润 (5) <= 利润阈值 (25) ✗
   - 利润分成 = 0 元
9. 配送员实际所得 = 4.0 + 0 = 4.0 元

**净利润计算**:
- 净利润 = 订单利润 - 平台总成本 = 5 - 4.0 = 1.0 元

**平台收支**:
- 平台收入 = 客户支付配送费 = 5 元
- 平台成本 = 配送员实际所得 + 优惠券抵扣 = 4.0 + 5 = 9.0 元
- 平台配送相关亏损 = 9.0 - 5 = 4.0 元
- 商品利润 = 5 元
- **平台总利润** = 商品利润 - 配送相关亏损 = 5 - 4.0 = 1.0 元
- **净利润** = 1.0 元（与上面计算结果一致）

---

## 五、数据存储

### 5.1 订单表中的字段

订单表 (`orders`) 中存储以下字段：

- `goods_amount`: 商品总金额
- `delivery_fee`: 客户支付的配送费
- `delivery_fee_calculation`: 配送费计算结果的 JSON（包含所有明细）
- `order_profit`: 订单利润
- `net_profit`: 净利润
- `is_isolated`: 是否孤立订单
- `weather_info`: 天气信息 JSON
- `is_urgent`: 是否加急订单

### 5.2 配送费计算结果 JSON 结构

```json
{
  "base_fee": 4.0,
  "isolated_fee": 3.0,
  "item_fee": 4.0,
  "urgent_fee": 0.0,
  "weather_fee": 0.0,
  "delivery_fee_without_profit": 11.0,
  "profit_share": 2.32,
  "rider_payable_fee": 13.32,
  "total_platform_cost": 13.32
}
```

---

## 六、计算时机

### 6.1 订单创建时
- 计算并存储配送费计算结果
- 计算并存储订单利润和净利润
- 更新订单的孤立状态和天气信息

### 6.2 订单状态更新时
- 重新计算配送费（因为孤立状态可能改变）
- 重新计算订单利润和净利润

### 6.3 订单修改时
- 重新计算配送费
- 重新计算订单利润和净利润

---

## 七、注意事项

1. **利润分成仅管理员可见**: 配送员视图中，利润分成明细显示为 0，但实际金额已包含在 `rider_payable_fee` 中。

2. **孤立订单判断**: 孤立订单的判断基于地理位置，不考虑用户。即使同一用户的多个订单，如果地理位置相邻，也不应该都算孤立。

3. **件数上限**: 商品件数补贴有上限（默认 50 件），超过上限的件数不再计算补贴。

4. **利润分成上限**: 利润分成有上限（默认 50 元），即使订单利润很高，分成也不会超过上限。

5. **成本计算**: 商品成本从商品规格的 `cost` 字段获取，如果成本为负数，则视为 0。

6. **价格计算**: 商品价格根据用户类型（批发/零售）选择，如果对应价格不存在或为 0，则使用备用价格或成本价。

7. **免费配送**: 客户支付的配送费可能为 0（免费配送），但配送员仍会获得配送费（由平台承担）。

8. **订单利润计算范围**: 订单利润只考虑商品本身的利润（商品总金额 - 商品总成本），**不包含**以下因素：
   - 客户支付的配送费（这是平台的额外收入）
   - 客户支付的加急费（这是平台的额外收入）
   - 优惠券抵扣（这是平台的成本，但不影响商品利润）
   - 积分抵扣（这是平台的成本，但不影响商品利润）

9. **加急费的区别**: 
   - **客户支付的加急费** (`urgent_fee`): 客户为加急订单支付的费用，是平台收入
   - **配送员获得的加急补贴** (`urgent_fee` in delivery fee calculation): 配送员因配送加急订单获得的补贴，是平台成本
   - 两者金额可能不同，客户支付的加急费通常高于配送员获得的加急补贴

10. **净利润计算**: 当前的净利润计算 = 订单利润 - 平台总成本（配送员实际所得），其中：
    - 订单利润只考虑商品利润
    - 平台总成本包括配送员的各种补贴和利润分成
    - **注意**：当前的净利润计算**未包含**客户支付的配送费、加急费收入和优惠券、积分抵扣成本
    - **真实利润**应该考虑所有收入和成本，见下面的详细说明

11. **真实利润计算**（完整版）：
    
    **真实利润 = 平台总收入 - 平台总成本 = 真实剩余的收入**
    
    真实利润应该考虑所有收入和成本：
    ```
    平台总收入 = 商品总金额 + 客户支付配送费 + 客户支付加急费
    平台总成本 = 商品总成本 + 配送员实际所得 + 优惠券抵扣 + 积分抵扣
    真实利润（真实剩余收入）= 平台总收入 - 平台总成本
    ```
    
    或者从另一个角度：
    ```
    真实利润 = 订单利润 + 客户支付配送费 + 客户支付加急费 - 配送员实际所得 - 优惠券抵扣 - 积分抵扣
    ```
    
    **重要说明**：
    - **真实利润**就是**平台真实剩余的收入**，即平台从该订单中实际获得的净收益
    - 如果真实利润为正数，表示平台盈利
    - 如果真实利润为负数，表示平台亏损
    
    **当前系统的净利润** (`net_profit`) 只计算了：
    ```
    净利润 = 订单利润 - 配送员实际所得
    ```
    
    这个净利润**未包含**：
    - 客户支付的配送费（平台收入）
    - 客户支付的加急费（平台收入）
    - 优惠券抵扣（平台成本）
    - 积分抵扣（平台成本）
    
    因此，**真实利润**才是平台从订单中获得的真实剩余收入。

---

## 八、简化利润计算示例

### 示例：使用简化方式计算利润

**订单信息**:
- 商品总金额：75.00元
- 商品总成本：47.50元（通过订单利润反推：75 - 27.5 = 47.5）
- 订单利润：27.50元
- 客户支付配送费：6.90元
- 优惠券抵扣：10.00元
- 加急费：0元
- 积分抵扣：0元
- 配送员实际所得：10.94元

**计算过程**：

**步骤1：计算平台总收入（实付金额）**
```
平台总收入 = 商品金额 + 配送费 + 加急费 - 优惠券抵扣 - 积分抵扣
          = 75.00 + 6.90 + 0 - 10.00 - 0
          = 71.90元
```

**步骤2：计算商品总成本**
```
商品总成本 = 商品总金额 - 订单利润
          = 75.00 - 27.50
          = 47.50元
```

**步骤3：计算毛利润**
```
毛利润 = 平台总收入 - 商品总成本
      = 71.90 - 47.50
      = 24.40元
```

**步骤4：计算配送成本**
```
配送成本 = 配送员实际所得
        = 10.94元
```

**步骤5：计算净利润**
```
净利润 = 平台总收入 - 商品总成本 - 配送成本
      = 71.90 - 47.50 - 10.94
      = 13.46元
```

或者：
```
净利润 = 毛利润 - 配送成本
      = 24.40 - 10.94
      = 13.46元
```

**结论**：
- **平台总收入** = 71.90元（实付金额）
- **商品总成本** = 47.50元
- **毛利润** = 24.40元
- **配送成本** = 10.94元
- **净利润** = 13.46元（平台真实剩余收入）

**说明**：
- 净利润就是平台从该订单中实际获得的净收益
- 如果净利润为正数，表示平台盈利
- 如果净利润为负数，表示平台亏损

---

## 九、相关代码文件

- `go_backend/internal/model/delivery_fee_calculator.go`: 配送费计算器（配送员实际所得）
- `go_backend/internal/model/delivery_fee.go`: 客户支付配送费计算（免费配送规则）
- `go_backend/internal/model/order.go`: 订单利润计算

---

## 十、配置建议

### 9.1 配送费配置建议

- **基础配送费**: 根据当地配送成本设置，建议 3-5 元
- **孤立订单补贴**: 建议 2-5 元，鼓励配送偏远订单
- **件数补贴**: 
  - 低档阈值建议 5-8 件
  - 高档阈值建议 10-15 件
  - 补贴率建议 0.3-0.8 元/件
- **加急订单补贴**: 建议 8-15 元
- **极端天气补贴**: 建议 1-3 元

### 9.2 利润分成配置建议

- **利润阈值**: 建议 20-30 元，低于此值不分成
- **分成比例**: 建议 5%-10%，根据平台盈利情况调整
- **最大分成**: 建议 30-50 元，避免单笔分成过高

---

## 十一、后台API和前端显示（简化版）

### 11.1 简化利润计算逻辑

为了更直观地查看订单利润，系统采用简化的计算方式：

```
平台总收入 = 实付金额（商品金额 + 配送费 + 加急费 - 优惠券抵扣 - 积分抵扣）
商品总成本 = 商品总金额 - 订单利润
毛利润 = 平台总收入 - 商品总成本
配送成本 = 配送员实际所得
净利润 = 平台总收入 - 商品总成本 - 配送成本 = 毛利润 - 配送成本
```

**说明**：
- **平台总收入**就是**实付金额**，已经包含了所有收入和扣减
- **净利润**就是平台从该订单中实际获得的净收益（真实剩余收入）

### 11.2 订单详情API新增字段

订单详情API (`GET /api/admin/orders/:id`) 现在返回以下字段：

#### `simplified_profit` (简化利润分析)
- **类型**: `object`
- **说明**: 简化的利润分析数据，只包含5个关键指标
- **字段说明**:
  - `platform_revenue`: 平台总收入（实付金额）
  - `goods_cost`: 商品总成本
  - `gross_profit`: 毛利润（平台总收入 - 商品总成本）
  - `delivery_cost`: 配送成本（配送员实际所得）
  - `net_profit`: 净利润（平台总收入 - 商品总成本 - 配送成本）

### 11.3 订单列表API新增字段

订单列表API (`GET /api/admin/orders`) 现在返回以下字段：

#### `simplified_profit` (简化利润分析)
- **类型**: `object`
- **说明**: 简化的利润分析数据
- **位置**: 每个订单对象中

### 11.4 后台管理系统前端显示

#### 订单列表页面
- **金额信息列**：显示商品金额、配送费、实付金额
- **利润信息**（简化显示）：
  - 平台总收入
  - 商品成本
  - 毛利润
  - 配送成本
  - **净利润**（高亮显示，绿色表示盈利，红色表示亏损）

#### 订单详情页面
- **利润信息**（简化显示，只显示5个关键指标）：
  - **平台总收入（实付金额）**：显示总额和明细构成
  - **商品总成本**：商品总金额 - 订单利润
  - **毛利润**：平台总收入 - 商品总成本，显示计算公式
  - **配送成本**：配送员实际所得
  - **净利润**：平台总收入 - 商品总成本 - 配送成本，显示计算公式和盈利/亏损状态

### 11.5 API响应示例

**订单详情API响应**:
```json
{
  "code": 200,
  "data": {
    "order": { ... },
    "order_items": [ ... ],
    "user": { ... },
    "address": { ... },
    "delivery_fee_calculation": { ... },
    "order_profit": 27.5,
    "net_profit": 16.56,
    "simplified_profit": {
      "platform_revenue": 71.9,
      "goods_cost": 47.5,
      "gross_profit": 24.4,
      "delivery_cost": 10.94,
      "net_profit": 13.46
    }
  },
  "message": "获取成功"
}
```

**订单列表API响应**:
```json
{
  "code": 200,
  "data": {
    "list": [
      {
        "id": 1,
        "order_number": "ORD20250127001",
        "goods_amount": 75.0,
        "delivery_fee": 6.9,
        "coupon_discount": 10.0,
        "total_amount": 71.9,
        "simplified_profit": {
          "platform_revenue": 71.9,
          "goods_cost": 47.5,
          "gross_profit": 24.4,
          "delivery_cost": 10.94,
          "net_profit": 13.46
        },
        ...
      }
    ],
    "total": 100
  },
  "message": "获取成功"
}
```

---

## 十二、计算公式总结

### 配送员实际所得
```
配送员实际所得 = 基础配送费 + 孤立订单补贴 + 商品件数补贴 + 加急订单补贴 + 极端天气补贴 + 利润分成
```

### 订单利润
```
订单利润 = 商品总金额 - 总成本
```

**注意**: 订单利润只考虑商品本身的利润，不包含配送费、加急费、优惠券等因素。

### 净利润
```
净利润 = 订单利润 - 平台总成本（配送费）
```

其中：
- **订单利润** = 商品总金额 - 商品总成本（不考虑配送费、加急费、优惠券）
- **平台总成本** = 配送员实际所得（包含利润分成）

### 利润分成
```
如果 订单利润 > 利润阈值:
    分成基数 = 订单利润 - 配送费（不含利润分成）
    利润分成 = min(max(分成基数 × 分成比例, 0), 最大分成)
否则:
    利润分成 = 0
```

---

### 简化利润计算（后台管理系统使用）

为了更直观地查看订单利润，后台管理系统采用简化的计算方式：

```
平台总收入 = 实付金额（商品金额 + 配送费 + 加急费 - 优惠券抵扣 - 积分抵扣）
商品总成本 = 商品总金额 - 订单利润
毛利润 = 平台总收入 - 商品总成本
配送成本 = 配送员实际所得
净利润 = 平台总收入 - 商品总成本 - 配送成本 = 毛利润 - 配送成本
```

**说明**：
- **平台总收入**就是**实付金额**，已经包含了所有收入和扣减
- **净利润**就是**平台真实剩余的收入**，即平台从该订单中实际获得的净收益
- 这是平台最终能够保留的利润，是衡量订单盈利能力的核心指标

### 完整利润计算（详细版）

如果需要查看完整的利润分析，可以使用以下公式：

```
平台总收入 = 商品总金额 + 客户支付配送费 + 客户支付加急费
平台总成本 = 商品总成本 + 配送员实际所得 + 优惠券抵扣 + 积分抵扣
真实利润 = 平台总收入 - 平台总成本
```

或者直接计算：
```
真实利润 = 订单利润 + 客户支付配送费 + 客户支付加急费 - 配送员实际所得 - 优惠券抵扣 - 积分抵扣
```

**注意**：完整版计算中，平台总收入不等于实付金额，因为实付金额已经扣除了优惠券和积分。

---

**文档版本**: 1.2  
**最后更新**: 2025-01-27  
**维护者**: 系统开发团队

**更新日志**:
- v1.2 (2025-01-27): 简化利润计算方式，使用更直观的计算公式（平台总收入=实付金额，净利润=平台总收入-商品总成本-配送成本），简化后台显示
- v1.1 (2025-01-27): 添加真实利润计算、后台API字段说明、前端显示说明
- v1.0 (2025-01-27): 初始版本，包含配送费计算模型和利润计算模型

