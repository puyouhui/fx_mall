# 供应商付款标记和对账系统方案

## 一、需求分析

### 1.1 核心问题
- **重复付款风险**：没有标记已付款的账单，可能导致重复付款
- **对账困难**：供应商无法查看哪些货物已经付款
- **财务对账**：需要清晰的付款记录和对账功能

### 1.2 解决方案
- 创建付款记录表，记录每次付款的详细信息
- 管理员可以标记订单商品为已付款
- 供应商后台可以查看已付款清单和对账
- 已付款的商品不再显示在待付款列表中

## 二、数据库设计

### 2.1 供应商付款记录表
```sql
CREATE TABLE IF NOT EXISTS supplier_payments (
    id INT PRIMARY KEY AUTO_INCREMENT,
    supplier_id INT NOT NULL COMMENT '供应商ID',
    payment_date DATE NOT NULL COMMENT '付款日期',
    payment_amount DECIMAL(10,2) NOT NULL COMMENT '付款金额',
    payment_method VARCHAR(50) COMMENT '付款方式：bank_transfer/cash/alipay/wechat',
    payment_account VARCHAR(100) COMMENT '付款账户',
    payment_receipt VARCHAR(255) COMMENT '付款凭证（图片URL）',
    remark TEXT COMMENT '备注',
    created_by VARCHAR(50) COMMENT '创建人（管理员账号）',
    status TINYINT DEFAULT 1 COMMENT '状态：1-有效，0-已撤销',
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    KEY idx_supplier_id (supplier_id),
    KEY idx_payment_date (payment_date),
    FOREIGN KEY (supplier_id) REFERENCES suppliers(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='供应商付款记录表';
```

### 2.2 供应商付款明细表（关联订单商品）
```sql
CREATE TABLE IF NOT EXISTS supplier_payment_items (
    id INT PRIMARY KEY AUTO_INCREMENT,
    payment_id INT NOT NULL COMMENT '付款记录ID',
    order_id INT NOT NULL COMMENT '订单ID',
    order_item_id INT NOT NULL COMMENT '订单商品ID',
    product_id INT NOT NULL COMMENT '商品ID',
    product_name VARCHAR(200) NOT NULL COMMENT '商品名称',
    spec_name VARCHAR(100) COMMENT '规格名称',
    quantity INT NOT NULL COMMENT '数量',
    cost_price DECIMAL(10,2) NOT NULL COMMENT '成本价',
    subtotal DECIMAL(10,2) NOT NULL COMMENT '小计',
    created_at DATETIME NOT NULL,
    KEY idx_payment_id (payment_id),
    KEY idx_order_id (order_id),
    KEY idx_order_item_id (order_item_id),
    FOREIGN KEY (payment_id) REFERENCES supplier_payments(id) ON DELETE CASCADE,
    FOREIGN KEY (order_id) REFERENCES orders(id),
    FOREIGN KEY (order_item_id) REFERENCES order_items(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='供应商付款明细表';
```

## 三、功能设计

### 3.1 管理员功能

#### 3.1.1 标记付款
- **入口**：供应商付款统计页面
- **操作流程**：
  1. 选择供应商
  2. 选择要付款的订单商品（支持批量选择）
  3. 填写付款信息（日期、金额、方式、账户、凭证）
  4. 确认付款
- **数据记录**：
  - 创建 `supplier_payments` 记录
  - 创建 `supplier_payment_items` 记录（关联每个订单商品）

#### 3.1.2 付款记录管理
- 查看所有付款记录
- 支持按供应商、日期范围筛选
- 可以撤销付款（软删除）
- 查看付款明细

### 3.2 供应商功能

#### 3.2.1 对账功能
- **已付款清单**：
  - 查看所有已付款的订单商品
  - 支持按日期、订单号筛选
  - 显示付款金额、付款日期、付款方式
- **待付款清单**：
  - 查看所有待付款的订单商品
  - 显示取货时间、应付款金额
- **对账统计**：
  - 总应付款、已付款、待付款
  - 按日期统计付款情况

## 四、API 设计

### 4.1 管理员接口

#### 4.1.1 创建付款记录
```
POST /admin/suppliers/payments
请求体：
{
  "supplier_id": 1,
  "payment_date": "2024-01-15",
  "payment_amount": 5000.00,
  "payment_method": "bank_transfer",
  "payment_account": "6222****1234",
  "payment_receipt": "https://...",
  "remark": "1月份货款",
  "order_items": [
    {
      "order_id": 123,
      "order_item_id": 456,
      "product_id": 1,
      "product_name": "商品A",
      "spec_name": "规格1",
      "quantity": 10,
      "cost_price": 5.50,
      "subtotal": 55.00
    }
  ]
}
```

#### 4.1.2 获取付款记录列表
```
GET /admin/suppliers/payments
参数：
- supplier_id: 供应商ID（可选）
- start_date: 开始日期（可选）
- end_date: 结束日期（可选）
- page: 页码
- page_size: 每页数量
```

#### 4.1.3 获取付款记录详情
```
GET /admin/suppliers/payments/:id
```

#### 4.1.4 撤销付款
```
DELETE /admin/suppliers/payments/:id
```

### 4.2 供应商接口

#### 4.2.1 获取已付款清单
```
GET /supplier/payments/paid
参数：
- start_date: 开始日期（可选）
- end_date: 结束日期（可选）
- order_number: 订单号（可选）
```

#### 4.2.2 获取待付款清单
```
GET /supplier/payments/pending
参数：
- start_date: 开始日期（可选）
- end_date: 结束日期（可选）
```

#### 4.2.3 获取对账统计
```
GET /supplier/payments/stats
参数：
- start_date: 开始日期（可选）
- end_date: 结束日期（可选）
```

## 五、前端页面设计

### 5.1 管理员页面

#### 5.1.1 付款标记页面
- 显示待付款订单商品列表
- 支持多选
- 填写付款信息表单
- 提交付款记录

#### 5.1.2 付款记录管理页面
- 付款记录列表
- 查看详情
- 撤销付款

### 5.2 供应商页面

#### 5.2.1 对账页面
- 已付款清单
- 待付款清单
- 对账统计图表

## 六、实现步骤

1. 创建数据库表
2. 实现后端 API
3. 实现管理员付款标记功能
4. 实现供应商对账功能
5. 测试验证

## 七、数据准确性保证

1. **唯一性约束**：每个订单商品只能被付款一次
2. **金额校验**：付款金额必须等于选中商品的总成本
3. **状态管理**：已付款的商品不再显示在待付款列表
4. **审计日志**：记录所有付款操作，支持追溯

