# 微信小程序订单中心与发货管理接入说明

为满足微信支付真机使用要求，需接入**小程序订单管理**和**发货信息管理服务**。本文档说明接入步骤及已实现的代码改动。

## 一、前置条件

### 1. 订单中心

- 在 [微信公众平台](https://mp.weixin.qq.com/) 完成**订单中心授权协议**签署
- 小程序需为**企业主体**

### 2. 发货信息管理服务

- 在 [微信公众平台](https://mp.weixin.qq.com/) 开通**发货信息管理服务**
- 完成**交易结算管理确认**（对关联商户号完成订单管理授权或解绑）

---

## 二、已实现的代码改动

### 1. 微信支付 description 优化

- **文件**：`go_backend/internal/api/wechat_pay.go`
- **说明**：支付时 `description` 改为商品名称拼接（如「商品A×2;商品B×1」），用于「小程序购物订单」展示，长度控制在 127 字符内。

### 2. 订单详情支持订单编号跳转

- **文件**：`go_backend/internal/api/order.go`、`mini_app/pages/order/detail.vue`
- **说明**：`GET /mini-app/users/orders/:id` 同时支持订单 ID 和订单编号（`order_number`）。从「我-订单与卡包-小程序购物订单」点击「前往小程序」时，微信会用 `out_trade_no`（即 `order_number`）替换 `${商品订单号}` 跳转。

### 3. 发货信息自动录入

- **文件**：`go_backend/internal/api/wechat_order_shipping.go`、`go_backend/internal/api/employee_delivery.go`
- **说明**：当订单状态变为「配送中」（`delivering`）时，自动调用微信 `upload_shipping_info` 接口录入发货信息（同城配送模式）。仅对微信支付订单（有 `wechat_transaction_id`）生效。

### 4. 管理员接口

- **配置订单详情跳转路径**：`POST /api/admin/wechat/order-detail-path`  
  - Body: `{"path": "pages/order/detail?id=${商品订单号}"}`
  - path 必须包含 `${商品订单号}`

- **手动补录发货信息**：`POST /api/admin/orders/:id/upload-wechat-shipping`  
  - 用于补录或修复未自动录入的订单

---

## 三、接入步骤

### 步骤 1：开通订单中心

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入「功能」→「订单中心」→ 签署授权协议
3. 按提示完成配置

### 步骤 2：配置订单详情跳转路径

在**首次上线前**调用一次接口（需管理员 token）：

```bash
POST /api/admin/wechat/order-detail-path
Content-Type: application/json
Authorization: Bearer <admin_token>

{
  "path": "pages/order/detail?id=${商品订单号}"
}
```

> 注意：path 必须包含 `${商品订单号}`，微信会用商户订单号（`order_number`）替换后跳转。

也可在管理后台增加「订单中心配置」页面，通过界面调用该接口。

### 步骤 3：开通发货信息管理服务

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入「功能」→「发货信息管理服务」→ 申请开通
3. 完成**交易结算管理确认**（商户号授权/解绑）

### 步骤 4：确认配置

- **小程序 AppID / AppSecret**：在 `config.Config.MiniApp` 中配置，用于获取 access_token 调用微信接口
- **微信支付商户号**：在系统设置中已配置的 `wechat_pay_*` 相关参数

---

## 四、流程说明

### 支付流程

1. 用户下单并支付 → 微信 JSAPI 下单时已传入：
   - `description`：商品描述（用于「小程序购物订单」）
   - `out_trade_no`：订单编号（用于跳转和发货录入）

### 发货流程

1. 配送员在配送 App 中**开始配送**（或全部取货后自动变为配送中）
2. 后端自动调用 `upload_shipping_info` 录入发货信息
3. 用户可在「我-订单与卡包-小程序购物订单」中查看物流信息
4. 资金按微信规则进行结算

### 补录发货

若自动录入失败，可在管理后台对对应订单调用 `POST /api/admin/orders/:id/upload-wechat-shipping` 进行补录。

---

## 五、参考文档

- [小程序购物订单](https://developers.weixin.qq.com/miniprogram/dev/platform-capabilities/business-capabilities/order_center/order_center.html)
- [小程序发货信息管理服务](https://developers.weixin.qq.com/miniprogram/dev/platform-capabilities/business-capabilities/order-shipping/order-shipping.html)
