# 退款售后逻辑排查报告

## 一、流程概览

### 1. 取消订单触发退款

| 入口 | 条件 | 逻辑 |
|------|------|------|
| 用户取消 (`CancelUserOrder`) | 待配送/待取货，且 `NeedWechatRefundOnCancel()` 为 true | 调用 `RequestWechatRefund` → 更新 `refund_status=processing` → 取消订单 → 清理分成 |
| 销售员取消 (`CancelSalesOrder`) | 同上 | 同上 |

`NeedWechatRefundOnCancel()` 条件：`PaidAt != nil` 且（`payment_method=online` 或 `wechat_transaction_id` 有值）

### 2. 管理员手动退款 (`AdminManualRefund`)

- **场景**：支付回调未同步等异常，用户已付款但订单未显示已支付
- **逻辑**：直接调用微信退款（`order_number` 作为 `out_trade_no`）→ 更新 `refund_status=processing` → 取消订单 → 清理分成

### 3. 售后退款 (`AdminRefundWithDetails`)

- **场景**：售后补偿、部分/全额退款
- **逻辑**：支持指定金额、原因，可选「全额退款后取消订单」

---

## 二、发现的逻辑问题

### ~~【严重】1. 未实现退款结果回调，refund_status 无法更新~~（已修复）

**已实现**：`WeChatRefundNotify`  handler（`POST /api/mini/wechat-pay/refund-notify`），解析微信退款通知并更新 `refund_status`。需在系统设置中配置 `wechat_pay_refund_notify_url` 为完整地址，如 `https://域名/api/mini/wechat-pay/refund-notify`。

---

### ~~【中等】2. 货到付款且未微信支付时仍可发起退款~~（已修复）

**场景**：`payment_method=cod` 且 `wechat_transaction_id` 为空（用户从未通过「去付款」支付）。

**现状**：`AdminRefundWithDetails`、`AdminManualRefund` 不做校验，直接调用微信退款接口，微信会因无对应支付记录而失败。

**已修复**：`AdminRefundWithDetails` 增加前置校验，当 `payment_method=cod` 且 `wechat_transaction_id` 为空时，直接返回明确提示，避免无效的微信 API 调用。

> 注意：`AdminManualRefund` 用于「支付回调未同步」场景，此时 `wechat_transaction_id` 也可能为空，因此未对该接口增加拦截。

---

### 【低】3. 手动退款对已退款订单无前置校验

**场景**：订单已退款成功，管理员再次点击「手动退款」。

**现状**：会再次发起退款，微信因 `outRefundNo` 重复（`order_number + "_refund"`）而拒绝，接口返回错误。

**影响**：逻辑正确，但会多一次无效的微信 API 调用。

**建议**：若 `refund_status=success`，可前置判断并提示「订单已退款，无需重复操作」。

---

### 【低】4. 多次部分退款时 wechat_refund_id 被覆盖

**场景**：同一订单多次售后退款（如先退 50 元，再退 50 元）。

**现状**：`RequestWechatRefundForOrder` 每次都会覆盖 `wechat_refund_id`，只保留最后一次退款的微信退款单号。

**影响**：无法从订单表追溯每笔退款的微信单号；超额退款仍由微信接口控制，不会重复退。

---

## 三、逻辑正确的部分

| 检查项 | 结论 |
|--------|------|
| 取消订单时的退款判断 | `NeedWechatRefundOnCancel` 正确区分在线支付/货到付款 |
| 手动退款幂等 | `outRefundNo = order_number + "_refund"` 固定，重复退款会被微信拒绝 |
| 售后退款金额校验 | 单次退款金额不超过 `order.TotalAmount` |
| 超额退款防护 | 微信按支付单累计退款金额校验，超额会拒绝 |
| 全额退款后取消订单 | 前端仅在全额退款时展示该选项，后端用 `refundAmount >= total-0.01` 判断 |
| 分成记录清理 | 取消订单时异步执行 `CancelOrderCommissions` |
| prepay-from-checkout 订单 | `order_number` 即支付时的 `out_trade_no`，退款可正常关联 |

---

## 四、与 prepay-from-checkout 的兼容性

prepay-from-checkout 创建订单时，`order_number` 即为微信支付的 `out_trade_no`。  
退款时使用 `order.OrderNumber` 作为 `OutTradeNo` 调用微信，与支付记录可正确对应，逻辑一致。

---

## 五、修复建议优先级

1. **高**：实现退款回调 `WeChatRefundNotify`，使 `refund_status` 能正确更新。
2. **中**：对货到付款且未微信支付的订单，在售后退款前增加校验并提前返回明确提示。
3. **低**：对手动退款增加 `refund_status=success` 的重复操作拦截。
