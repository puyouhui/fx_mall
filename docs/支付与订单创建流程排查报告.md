# 支付与订单创建流程排查报告

## 一、流程概览

### 1. 在线支付（prepay-from-checkout）

```
用户确认页 → 收银台(选在线支付) → 点击确认支付
  → POST /wechat-pay/prepay-from-checkout (校验、缓存、调微信预支付)
  → 返回 prepay 参数
  → wx.requestPayment()
  → 支付成功 → 微信回调 WeChatPayNotify
  → 回调：查订单 → 无则查缓存 → 创建订单 → 清采购单
  → 前端跳转订单详情（用 order_number 即 out_trade_no），详情页轮询直到订单出现
```

### 2. 货到付款

```
收银台(选货到付款) → 点击提交订单
  → POST /orders (CreateOrderFromCart)
  → 创建订单、清采购单
  → 跳转订单详情
```

### 3. 已存在订单的在线支付（如 COD 转在线）

```
订单详情页 → 去支付
  → POST /orders/:id/wechat-pay/prepay
  → 使用 order_number 作为 out_trade_no
  → 微信回调 → MarkOrderPaidByWechatPay
```

---

## 二、发现的漏洞与边缘问题

### 【严重】1. 缓存过期时回调误返 SUCCESS

**场景**：用户点击支付后，在收银台停留超过 30 分钟才完成支付，或网络延迟导致回调到达时缓存已过期。

**现状**：`GetPrepayCache` 返回错误时，代码 `return c.JSON(200, "SUCCESS")`，告知微信处理成功。

**后果**：用户已扣款，但订单未创建，且微信不会重试。

**修复**：缓存不存在/过期时返回 `FAIL`，让微信重试；并记录告警便于人工补单。

---

### 【严重】2. 预支付失败后未回滚缓存

**场景**：`SetPrepayCache` 成功，但调用微信 prepay 接口失败（网络、配置等）。

**现状**：缓存已写入，但用户不会支付，缓存会自然过期。

**影响**：可接受，仅产生无效缓存条目。但若 prepay 因 `out_trade_no` 重复失败，旧缓存会覆盖新缓存（同 key  overwrite）。实际上每次 prepay 都生成新 out_trade_no，不会覆盖。

---

### 【中等】3. out_trade_no 碰撞风险

**现状**：`GenerateOutTradeNo` = `P` + 14 位时间(秒) + 6 位随机数。

**分析**：同一秒内碰撞概率约 1/100 万。若碰撞，第二个 prepay 调用微信时会因 out_trade_no 重复失败，用户可重试。建议增加随机性（如纳秒或更多位）以降低风险。

---

### 【中等】4. 微信回调并发时的订单重复创建

**场景**：微信同时或快速连续发送多次回调。

**分析**：`orders.order_number` 有 UNIQUE 约束，第二个 `CreateOrderFromCachedPrepay` 的 INSERT 会失败并回滚。回调返回 500，微信会重试；重试时订单已存在，会走「订单已支付」逻辑并返回 SUCCESS。逻辑正确。

---

### 【低】5. 采购单清理逻辑的 item_ids 处理

**场景**：`ItemIDs` 为空时删除用户全部采购单；非空时按 ID 删除。

**分析**：当 `ItemIDs` 含无效 ID（≤0）时，会跳过这些 ID。若全部无效，`validIDs` 只有 userID，会直接 return 不执行删除，导致采购单未清理。

**建议**：`ItemIDs` 全部无效时，应退化为删除该用户全部采购单，与 `len(itemIDs)==0` 行为一致。

---

### 【低】6. 前端支付成功后跳转时机

**现状**：支付成功后立即 `redirectTo` 订单列表，此时回调可能尚未完成，订单可能尚未创建。

**影响**：用户可能看到「暂无订单」，需手动刷新。建议增加「支付成功，订单生成中」的提示或短时轮询。

---

## 三、CreateOrderFromCart 与 WeChatPrepayFromCheckout 逻辑对比

| 校验项           | CreateOrderFromCart | WeChatPrepayFromCheckout |
|------------------|---------------------|---------------------------|
| 地址校验         | ✓                   | ✓                         |
| 采购单非空       | ✓                   | ✓                         |
| item_ids 过滤    | ✓                   | ✓                         |
| 成本价校验       | ✓                   | ✓                         |
| 配送费计算       | ✓                   | ✓                         |
| 优惠券计算       | ✓                   | ✓                         |
| 加急费           | ✓                   | ✓                         |
| 金额≥0.01        | -                   | ✓（prepay 特有）          |

---

## 四、与 CreateOrderFromPurchaseList 的一致性

`CreateOrderFromCachedPrepay` 与 `CreateOrderFromPurchaseList` 在金额、优惠券、订单字段上的处理一致，未发现逻辑偏差。

---

## 五、修复建议汇总

1. **必须**：缓存过期/不存在时，回调返回 FAIL 而非 SUCCESS。
2. **建议**：`out_trade_no` 增加纳秒或更多随机位，降低碰撞概率。
3. **建议**：`ClearPurchaseListByItemIDs` 在 `ItemIDs` 全部无效时，按「清空用户采购单」处理。
4. **可选**：前端支付成功后增加「订单生成中」提示或短暂轮询，改善体验。

---

## 六、支付成功但订单不出现 - 排查指南

当用户支付成功但订单列表中查不到订单时，可按以下步骤排查：

### 1. 检查后端日志

- **若看到** `[WeChatPrepayFromCheckout] 预支付缓存已写入 out_trade_no=P...`  
  → 说明预支付成功，缓存已写入。

- **若看到** `[WeChatPayNotify] 收到微信支付回调请求`  
  → 说明微信回调已到达服务器，继续看后续日志。

- **若看到** `[WeChatPayNotify] 解析成功 out_trade_no=... transaction_id=...`  
  → 说明回调验签成功。

- **若看到** `[WeChatPayNotify] 从缓存创建订单成功`  
  → 说明订单已创建，若前端仍查不到，可能是订单列表筛选/分页问题。

- **若看到** `[WeChatPayNotify] 严重：订单不存在且预支付缓存无效`  
  → 回调到达时缓存已过期或不存在，检查：预支付与支付完成是否间隔超过 30 分钟；或服务是否重启（内存缓存会清空）。

- **若完全没有** `[WeChatPayNotify]` 相关日志  
  → 微信回调未到达，优先检查回调地址配置。

### 2. 检查回调地址配置

- 系统设置 `wechat_pay_notify_url` 必须为：`https://你的域名/api/mini/wechat-pay/notify`
- 必须是 **公网 HTTPS**，微信服务器需能访问。
- 本地开发、内网环境微信无法访问，回调不会到达。
- 确认域名解析正确，且无防火墙/安全组拦截 443 端口。

### 3. 前端行为（当前实现）

- 支付成功后跳转至 **订单详情页**（`id=out_trade_no`）。
- 订单详情页会轮询最多 30 秒，直到订单创建完成。
- 若超时仍未获取到订单，会提示「订单生成较慢，请稍后从订单列表查看」。
